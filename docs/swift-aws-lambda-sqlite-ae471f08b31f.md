# å°† Swift AWS Lambda ä¸ SQLite è¿æ¥

> åŸæ–‡ï¼š<https://medium.com/nerd-for-tech/swift-aws-lambda-sqlite-ae471f08b31f?source=collection_archive---------6----------------------->

![](img/3ee7de08afbdf5d47ac2fc0d4db40f35.png)

å¾·ç±³ç‰¹é‡ŒÂ·é©¬ä»€é‡‘åœ¨ [Unsplash](https://unsplash.com/s/photos/blocks-lego?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šçš„ç…§ç‰‡

å»å¹´åœ¨ 2020 å¹´ï¼ŒSwift æ­£å¼æ”¯æŒ AWS lambdaï¼Œè‹¹æœåœ¨ WWDC 2020 ä¸Šåˆ¶ä½œäº†è§†é¢‘ï¼ŒSwift ä¸ AWS Lambda é…åˆä½¿ç”¨ã€‚

ç›®å‰åœ¨æˆ‘çš„å·¥ä½œé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸°å¯Œçš„ iOS åº”ç”¨ç¨‹åºï¼Œä¸°å¯Œçš„æ„æ€æ˜¯ç”¨æˆ·çš„æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯åœ¨ iOS swift ä¸­ç¼–å†™çš„ï¼Œç”Ÿæˆ PDFï¼Œä¸šåŠ¡éªŒè¯ï¼Œè®¡ç®—ç­‰ã€‚å®ƒä¸åƒä»¥å‰çš„å®¢æˆ·-æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚

å› æ­¤ï¼Œæœ‰äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å°†è¿™äº›åŠŸèƒ½è½¬ç§»åˆ° AWS Lambda æˆ–åç«¯æœåŠ¡ä¸­ï¼Œä»¥ä¾¿å…¶ä»–äººå¯ä»¥ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚å½“ç„¶ä¼šæœ‰ä¸€äº›éšœç¢ï¼Œä½†æˆ‘åœ¨[è¿™é‡Œ](https://tirtavium.medium.com/the-things-you-need-to-consider-before-make-your-ios-mac-functions-run-on-aws-lambda-linux-a3ea26c9f270)åˆ†äº«äº†è¿™äº›é—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« çš„é‡ç‚¹æ˜¯åœ¨ AWS Lambda ä¸Šé›†æˆ swift SQLiteï¼Œåœ¨ä½¿æˆ‘ä»¬çš„ swift ä»£ç åº“æ”¯æŒå¤šå¹³å°(iOSã€Macã€Linuxã€android)ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ä»€ä¹ˆğŸ˜).

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¦‚æ ‡é¢˜æ‰€è¿°ï¼Œæˆ‘å°†åˆ†äº«å¦‚ä½• Swift AWS Lambda æ”¯æŒ SQLite çš„æºä»£ç ï¼Œæ‚¨å¯ä»¥åœ¨æˆ‘çš„ [**github**](https://github.com/tirtavium/Swift-AWS-Lambda-SQLite) æŸ¥çœ‹ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦è€ƒè™‘ï¼Œåœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨ SQLite çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œæ˜¯ä¸ºäº†åƒæ™®é€š RDBMS ä¸€æ ·æ·»åŠ è®°å½•å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œä½ éœ€è¦ä¸‰æ€è€Œè¡Œï¼Œå› ä¸º AWS lambda å­˜å‚¨ä»…é€‚ç”¨äº 512MBï¼Œæˆ‘çš„å»ºè®®æ˜¯ä½ éœ€è¦æ¶ˆé™¤è¿™ç§æƒ³æ³•ï¼Œå¹¶ä½¿ç”¨å…¶ä»–æœåŠ¡ï¼Œå¦‚ AWS DynamoDB æˆ– RDSã€‚

å¦‚æœæ‚¨åªéœ€è¦åªè¯»ï¼Œå› ä¸ºæ•°æ®åº“ä¸­æœ‰å¦‚æ­¤å¤šçš„é™æ€æ•°æ®ï¼Œå¹¶ä¸”å¤§å°å°äº 512MBï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ç»§ç»­åœ¨ AWS Lambda ä¸Šä½¿ç”¨æ‚¨çš„ swift ä»£ç åº“ï¼Œåœ¨æ‚¨å°†å®ƒéƒ¨ç½²åˆ° AWS Lambda å¹¶è°ƒç”¨ä¸€äº›åŠŸèƒ½åï¼Œæ‚¨è¿˜éœ€è¦è€ƒè™‘æ€§èƒ½æˆæœ¬ï¼Œæˆ‘çš„å»ºè®®æ˜¯ç¬¬ä¸€æ­¥æ˜¯é’ˆå¯¹æœ€ç®€å•çš„åŠŸèƒ½ï¼Œå¹¶æŸ¥çœ‹è¯¥åŠŸèƒ½çš„æ€§èƒ½ã€‚å¦‚æœç»“æœé€šè¿‡äº†æ‚¨çš„ç”¨æˆ·æ•°æ®çš„ä¼°è®¡ï¼Œæ‚¨å¯ä»¥ç»§ç»­ä½¿ç”¨ Lambdaã€‚

**å…ˆå†³æ¡ä»¶**

1.  Xcode 12ï¼Œå› ä¸º swift åŒ…ç®¡ç†å™¨ä» xcode 12 å¼€å§‹æ”¯æŒèµ„æº itï¼Œå‡†ç¡®åœ°è¯´ï¼Œå®ƒéœ€è¦ swift-tools-version:5.3
2.  ç å¤´å·¥äººï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªä¸ºæˆ‘ä»¬çš„ lambda åšå®¹å™¨ã€‚

æˆ‘å°†è§£é‡Š package.swift

**äº§å“:**å®ƒæœ‰**å¯æ‰§è¡Œæ–‡ä»¶**ï¼Œåç§°ä¸º **AccountServiceAWSï¼Œ**è¿™éœ€è¦ä¸**æº**æ–‡ä»¶å¤¹ç›®å½•ç›¸åŒ¹é…ï¼Œæ‚¨å¯èƒ½è¿˜éœ€è¦æŸ¥çœ‹é¡¹ç›®çš„**åº“**æ ‡ç­¾ï¼Œå› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æ„å‘³ç€æ‰§è¡Œçš„ç»“æœå°†æ˜¯æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œå¦‚æœåº“ç»“æœå°†æ˜¯è¦ä½¿ç”¨çš„åº“ã€‚

> **æ³¨æ˜**:ä¸æ”¯æŒ**å¯æ‰§è¡Œ**äº§å“**è¦è¿›è¡Œ**å•å…ƒæµ‹è¯•**ï¼Œæ‚¨å¯ä»¥ä¸ºæ‚¨çš„ä¸šåŠ¡ä»£ç åˆ›å»ºåº“ï¼Œå¹¶ä¸ºä¾èµ–äº AWS lambda è¿è¡Œæ—¶çš„ä¸œè¥¿åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‡ºäºç¤ºä¾‹ç›®çš„ï¼Œæˆ‘ä¸åœ¨æ­¤è€ƒè™‘ã€‚**

**ä¾èµ–é¡¹:**æ‰€æœ‰éœ€è¦çš„ä¾èµ–é¡¹éƒ½åœ¨è¿™é‡Œï¼Œå› ä¸ºç°åœ¨å®ƒåªéœ€è¦ AWS lambda è¿è¡Œæ—¶ã€AWS lambda åº“å’Œ Soto åº“æ¥è¿æ¥åˆ°è¿™ä¸ªç¤ºä¾‹çš„å…¶ä»– AWS æœåŠ¡æ˜¯ S3ã€‚

**targets:** Targets æ˜¯ä¸€ä¸ªåŒ…çš„åŸºæœ¬æ„é€ å—ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå®ƒåªåŒ…å« 1 ä¸ª targetï¼ŒåŒ…å«æ‰€æœ‰éœ€è¦çš„ä¾èµ–é¡¹å’Œèµ„æºï¼Œ **systemLibrary** æ˜¯å®‰è£…åœ¨ç³»ç»Ÿä¸Šçš„åº“ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ **SQLite3** è¿™æ˜¯ C åº“ï¼Œæˆ‘ä»¬éœ€è¦ç¨ååœ¨ docker æ˜ åƒä¸Šå®‰è£…å®ƒï¼Œæ­£å¦‚æ‚¨å¯ä»¥çœ‹åˆ°çš„ï¼Œsources æ–‡ä»¶å¤¹ä¸Šæœ‰æ–‡ä»¶å¤¹ CSQLite3ï¼Œ **testTarget** ç”¨äºå•å…ƒæµ‹è¯•ã€‚

å¦‚æœæ‚¨ä½¿ç”¨ Xcodeï¼Œæ‚¨å¯ä»¥ç›´æ¥è¿è¡Œé¡¹ç›®å¹¶ç”¨ curl éªŒè¯å®ƒ:

```
$ curl --header "Content-Type: application/json" \
--request POST \
--data '{"id": 1}' \
http://localhost:7000/invoke
```

å®ƒä¼šè¿™æ ·å›åº”

```
{
 "account":{
    "ID":1,
    "dateOfBirth":"10-12-1991",
    "Name":"Hanif",
    "email":"hanif@gmail.com"
 },
 "message":"success"
}
```

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ Package.swift ä¸­æœ‰ account.db ä½œä¸ºèµ„æºï¼Œå¹¶ä¸”å› ä¸ºæˆ‘ä»¬åœ¨ mac ä¸Šè¿è¡Œå®ƒï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä»¥è¿™ç§çŠ¶æ€éƒ¨ç½²åˆ° AWS lambdaï¼Œæˆ‘ä»¬å°†å¾—åˆ° resource_bundle_accessor çš„é”™è¯¯ï¼Œå› æ­¤ mac å’Œ AWS Lambda ä¹‹é—´æœ‰ä¸åŒçš„è¡Œä¸ºã€‚

![](img/1d7c262c25530defa71e770729f277be.png)

èµ„æºæ†ç»‘åŒ…å­˜å–å™¨

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°† accountData.db ä¸Šä¼ åˆ° S3 æ¡¶ä¸­ï¼Œä¸‹è½½å¹¶ä¿å­˜åˆ° AWS Lambda ä¸Šçš„/tmp æ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹åªæœ‰ 512MB çš„å­˜å‚¨é™åˆ¶ã€‚

ä¸ºäº†å°†æˆ‘ä»¬çš„åŠŸèƒ½è¿æ¥åˆ° AWS S3ï¼Œæˆ‘ä»¬éœ€è¦ç´¢æ‰˜å’Œ S3 è®¿é—®å¯†é’¥ï¼Œåœ¨æ‚¨æ‹¥æœ‰å®ƒä¹‹åï¼Œæ‚¨å¯ä»¥å°†å…¶æ”¾åœ¨ **SharedResource.swift**

```
**static** **public** **let** s3BucketName = "calculationservice"**static** **public** **let** awsClient = AWSClient(credentialProvider: .static(accessKeyId: "xxxx", secretAccessKey: "xxxxx"),httpClientProvider: .createNew)
```

s3BucketName æ˜¯æ‚¨å­˜å‚¨çš„ accountData.db å­˜å‚¨æ¡¶ï¼Œæ‚¨éœ€è¦ç”¨æ‚¨çš„å­˜å‚¨æ¡¶æ›¿æ¢ accessKeyId å’Œ secretAccessKeyï¼Œä»¥ä¾¿èƒ½å¤Ÿè®¿é—® accountData.dbã€‚

ç»è¿‡è¿™ä¸€æ­¥ï¼Œä½ å¯ä»¥å»ç å¤´éƒ¨åˆ†ã€‚

é¦–å…ˆä½ éœ€è¦ç”¨å®ƒæ¥æ„å»º docker å®¹å™¨ã€‚

```
$ docker run \
   --rm \
   --volume "$(pwd)/:/src" \
   --workdir "/src/" \
   swift:5.3.1-amazonlinux2 \
  /bin/bash -c "yum -y install sqlite-devel && swift build --product AccountServiceAWS -c release -Xswiftc -static-stdlib"
```

æ‰€ä»¥å®ƒä½¿ç”¨ swift:5.3.1-amazonlinux2ï¼Œå¹¶å®‰è£…äº† sqlite-develï¼ŒAccountServiceAWS æ˜¯æˆ‘ä»¬æ‹¥æœ‰çš„äº§å“ã€‚

æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œè¿™ä¸ªè„šæœ¬

```
$ ./scripts/package.sh AccountServiceAWS
```

è¿™æ˜¯ä¸€ä¸ªåˆ›å»ºåŒ…ä¸Šä¼ åˆ° AWS Lambdaã€‚

å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨*ä¸Šçœ‹åˆ°ç»“æœã€‚build/lambda/AccountServiceAWS/lambda . zip*

è¿™ä¸ª lambda.zip éœ€è¦ä¸Šä¼ åˆ° S3ï¼Œå› ä¸ºç›´æ¥ä¸Šä¼ åˆ° AWS lambda çš„æœ€å¤§å®¹é‡æ˜¯ 10MBï¼Œè€Œæˆ‘ä»¬çš„ lambda.zip æ˜¯ 30MBã€‚

ä¸Šä¼ åï¼Œä½ å¯ä»¥å›åˆ° AWS lambda å’ŒåŠŸèƒ½ä»£ç ï¼Œä»äºšé©¬é€Š S3 ä¸Šä¼ æ–‡ä»¶ã€‚

![](img/9312803fe7718043f8a91560dde21d67.png)

å¦‚æœè¿™æˆåŠŸäº†ï¼Œä½ å¯ä»¥ç”¨æµ‹è¯•äº‹ä»¶æµ‹è¯•è¿™ä¸ªå‡½æ•°ï¼Œå¹¶æŠŠå®ƒè¯·æ±‚æˆè¿™æ ·ã€‚

![](img/ebe389a067d36e06b7fffee5585ac861.png)

ç‚¹å‡»æµ‹è¯•ï¼Œæ‚¨å°†çœ‹åˆ°ä¸æ‚¨åœ¨æœºå™¨ç»ˆç«¯ä¸Šçœ‹åˆ°çš„ç»“æœç›¸åŒçš„ç»“æœã€‚

![](img/f6d8cacf20b4732c3aabbfde3a8b13a9.png)

æˆåŠŸ

# å®Œæˆï¼Œè°¢è°¢ä½ ğŸ™