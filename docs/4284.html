<html>
<head>
<title>Using Terraform to enable automatic tuning mode in an individual Azure SQL Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨ Terraform åœ¨å•ä¸ª Azure SQL æ•°æ®åº“ä¸­å¯ç”¨è‡ªåŠ¨è°ƒä¼˜æ¨¡å¼</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/nerd-for-tech/using-terraform-to-enable-automatic-tuning-mode-in-an-individual-azure-sql-database-1e2cf3e6a21f?source=collection_archive---------8-----------------------#2021-07-14">https://medium.com/nerd-for-tech/using-terraform-to-enable-automatic-tuning-mode-in-an-individual-azure-sql-database-1e2cf3e6a21f?source=collection_archive---------8-----------------------#2021-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c866b75481e4453f8db19e8a31a9c913.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6KAyvZ8CqVZCy8X1HrzLw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">è°ƒä¸€ä¸‹ï¼â€”ç”±<a class="ae iu" href="https://www.pexels.com/nl-nl/@cottonbro?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> cottonbro </a>é€šè¿‡<a class="ae iu" href="https://www.pexels.com/nl-nl/foto/hand-gezichtsloos-muziek-musicus-4708867/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">åƒç´ </a>è¿›è¡Œ Pic</figcaption></figure><h1 id="f562" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ’¡ä»‹ç»</h1><p id="b846" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Azure SQL Database è‡ªåŠ¨ç®¡ç†æ•°æ®æœåŠ¡ï¼Œè¿™äº›æœåŠ¡æŒç»­ç›‘æ§æ‚¨çš„æŸ¥è¯¢ï¼Œå¹¶ç¡®å®šæ‚¨å¯ä»¥æ‰§è¡Œçš„æ“ä½œï¼Œä»¥æé«˜å·¥ä½œè´Ÿè½½çš„æ€§èƒ½ã€‚æ‚¨å¯ä»¥æ£€æŸ¥å»ºè®®å¹¶æ‰‹åŠ¨åº”ç”¨å®ƒä»¬ï¼Œæˆ–è€…è®© Azure SQL æ•°æ®åº“è‡ªåŠ¨åº”ç”¨çº æ­£æªæ–½â€”è¿™å°±æ˜¯æ‰€è°“çš„è‡ªåŠ¨è°ƒä¼˜æ¨¡å¼ã€‚</p><p id="7f10" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åœ¨æœåŠ¡å™¨æˆ–æ•°æ®åº“çº§åˆ«å¯ç”¨è‡ªåŠ¨è°ƒä¼˜:</p><ul class=""><li id="ecaf" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">è“è‰²é—¨æˆ· 1ï¸âƒ£</li><li id="6e42" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">2ï¸âƒ£ REST API è°ƒç”¨</li><li id="d8cd" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">3ï¸âƒ£ T-SQL å‘½ä»¤</li></ul><h1 id="8670" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ”æŒ‘æˆ˜</h1><p id="0b90" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">æ­£å¦‚ä½ ä»ä¸Šé¢çš„ 1ï¸âƒ£ã€2ï¸âƒ£å’Œ 3ï¸âƒ£çœ‹åˆ°çš„ï¼Œç›®å‰ä¸å¯èƒ½é€šè¿‡ Azure CLI æˆ– ARM (Azure Resource Manager)æ¨¡æ¿å¯ç”¨è‡ªåŠ¨è°ƒæ•´ã€‚ä½†æ˜¯ä¸ç”¨æ‹…å¿ƒâ€”â€”è¿™ä¸ªå­˜å‚¨åº“ä¸­çš„ç¤ºä¾‹æä¾›äº†ä¸€ä¸ªæ›¿ä»£çš„éƒ¨ç½²é€‰é¡¹ã€‚å®ƒæ‰©å±•äº† T-SQL å‘½ä»¤é€‰é¡¹(3ï¸âƒ£),ä½¿ç”¨ Terraform åœ¨å•ä¸ª Azure SQL æ•°æ®åº“ä¸­å®ç°è‡ªåŠ¨è°ƒä¼˜ï¼</p><p id="b843" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿˜ä¸èƒ½ä½¿ç”¨ Terraform <code class="du lk ll lm ln b">azurerm_mssql_database</code>èµ„æºæ¥å¯ç”¨æ­¤åŠŸèƒ½ã€‚å› æ­¤ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆä½¿ç”¨äº†<code class="du lk ll lm ln b">null_resource</code>åœ°å½¢èµ„æºå’Œ<code class="du lk ll lm ln b">sqlcmd</code>å·¥å…·ã€‚</p><h1 id="55f1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ”§å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h1><p id="ba51" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">å¦‚<a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource" rel="noopener ugc nofollow" target="_blank">åœ°å½¢æ–‡ä»¶</a>æ‰€è¿°:</p><blockquote class="lo lp lq"><p id="68ac" class="jt ju lr jv b jw kr jy jz ka ks kc kd ls kt kg kh lt ku kk kl lu kv ko kp kq hb bi translated"><code class="du lk ll lm ln b">null_resource</code>èµ„æºå®ç°äº†æ ‡å‡†çš„èµ„æºç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯æ²¡æœ‰é‡‡å–è¿›ä¸€æ­¥çš„è¡ŒåŠ¨ã€‚</p><p id="f313" class="jt ju lr jv b jw kr jy jz ka ks kc kd ls kt kg kh lt ku kk kl lu kv ko kp kq hb bi translated"><code class="du lk ll lm ln b">triggers</code>å‚æ•°å…è®¸æŒ‡å®šä»»æ„ä¸€ç»„å€¼ï¼Œå½“è¿™äº›å€¼è¢«æ›´æ”¹æ—¶ï¼Œå°†å¯¼è‡´èµ„æºè¢«æ›¿æ¢ã€‚</p></blockquote><p id="6a46" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">å…³é”®å±æ€§æ˜¯<code class="du lk ll lm ln b">depends_on = [azurerm_mssql_database.test]</code>å’Œ<code class="du lk ll lm ln b">triggers = { always_run = timestamp() }</code>ã€‚</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="6f75" class="md iw hi ln b fi me mf l mg mh">resource "null_resource" "db_setup" {<br/>  depends_on = [azurerm_mssql_database.test]</span><span id="f7ac" class="md iw hi ln b fi mi mf l mg mh">  triggers = {<br/>    always_run = timestamp()<br/>  }</span><span id="981d" class="md iw hi ln b fi mi mf l mg mh">  provisioner "local-exec" {<br/>    command = "sqlcmd -S ${azurerm_mssql_server.example.name}.database.windows.net -d ${azurerm_mssql_database.test.name} -U ${var.administrator_login} -P ${var.administrator_login_password} -i ./auto-tuning.sql"<br/>  }<br/>}</span></pre><p id="72e4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">è¿™ç¡®ä¿äº†<code class="du lk ll lm ln b">sqlcmd</code>å®ç”¨ç¨‹åºæ€»æ˜¯åœ¨<code class="du lk ll lm ln b">terraform apply</code>ä¸­æ‰§è¡Œ<code class="du lk ll lm ln b">auto-tuning.sql</code>å‘½ä»¤ã€‚</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="154d" class="md iw hi ln b fi me mf l mg mh">-- Enable automatic tuning on an individual database<br/>ALTER DATABASE current SET AUTOMATIC_TUNING (CREATE_INDEX = ON);</span></pre><p id="29ee" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">â—é‡è¦æç¤º:è¯·æ³¨æ„ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­,(ç”Ÿæˆçš„)MS SQL Server ç®¡ç†å‘˜å‡­è¯ç”¨äºæ‰§è¡Œ<code class="du lk ll lm ln b">auto-tuning.sql</code>å‘½ä»¤ã€‚</p><blockquote class="lo lp lq"><p id="b8a9" class="jt ju lr jv b jw kr jy jz ka ks kc kd ls kt kg kh lt ku kk kl lu kv ko kp kq hb bi translated">è¦ä½¿ç”¨è‡ªåŠ¨è°ƒä¼˜ï¼Œæˆäºˆç”¨æˆ·çš„æœ€ä½è¦æ±‚æƒé™æ˜¯ Azure çš„å†…ç½® SQL æ•°æ®åº“è´¡çŒ®è€…è§’è‰²ã€‚æ‚¨è¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´é«˜æƒé™çš„è§’è‰²ï¼Œå¦‚ SQL Server å‚ä¸è€…ã€SQL æ‰˜ç®¡å®ä¾‹å‚ä¸è€…ã€å‚ä¸è€…å’Œæ‰€æœ‰è€…ã€‚(<a class="ae iu" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/automatic-tuning-enable#permissions" rel="noopener ugc nofollow" target="_blank">è‡ªåŠ¨è°ƒè°æƒé™â€”å¾®è½¯æ–‡æ¡£</a>)</p></blockquote><h1 id="6087" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ“è¦æ±‚</h1><ul class=""><li id="d610" class="kw kx hi jv b jw jx ka kb ke mj ki mk km ml kq lb lc ld le bi translated">âœ… Azure è®¢é˜…</li><li id="aa90" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">âœ… <a class="ae iu" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="0b56" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">âœ… <a class="ae iu" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">åœ°å½¢</a></li><li id="6759" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">âœ… <a class="ae iu" href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=azuresqldb-current" rel="noopener ugc nofollow" target="_blank"> sqlcmd å®ç”¨ç¨‹åº</a></li></ul><h1 id="ca5c" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ”§ä½¿ç”¨</h1><p id="30ea" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">åœ¨å…‹éš†äº†è¿™ä¸ªå­˜å‚¨åº“å¹¶å®‰è£…äº†åŸºæœ¬éœ€æ±‚ä¹‹åï¼Œåœ¨<code class="du lk ll lm ln b">./src/terraform</code>ç›®å½•ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="0130" class="md iw hi ln b fi me mf l mg mh"># Login to an Azure subscription<br/>az login</span><span id="2d36" class="md iw hi ln b fi mi mf l mg mh"># Initializes Terraform<br/>terraform init</span><span id="ea0b" class="md iw hi ln b fi mi mf l mg mh"># Plans and applies this sample's Azure infrastructure using Terraform<br/># It will prompt you for your current IP Address<br/>terraform plan<br/>terraform apply</span></pre><p id="5232" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">ğŸ•å‡ åˆ†é’Ÿåï¼Œ<code class="du lk ll lm ln b">terraform apply</code>çš„é¢„æœŸè¾“å‡ºåº”è¯¥æ˜¯:</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="5d6e" class="md iw hi ln b fi me mf l mg mh">null_resource.db_setup: Destroying... [id=630773934331976362]<br/>null_resource.db_setup: Destruction complete after 0s<br/>null_resource.db_setup: Creating...<br/>null_resource.db_setup: Provisioning with 'local-exec'...<br/>null_resource.db_setup (local-exec): (output suppressed due to sensitive value in config)<br/>null_resource.db_setup: Creation complete after 0s [id=7937627834098869972]</span></pre><p id="8ad5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">âœ”ï¸æ‚¨å¯ä»¥ä½¿ç”¨<a class="ae iu" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure Portal </a>ç¡®è®¤è‡ªåŠ¨è°ƒä¼˜å·²å¯ç”¨ï¼Œå¹¶æ‰“å¼€ SQL æ•°æ®åº“è‡ªåŠ¨è°ƒä¼˜è®¾ç½®:</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/3b46b23299663a2a61b19b2e9bdeeeec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IUvUJILNHtt7zmmA.png"/></div></div></figure><h1 id="6cb2" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸš¿æ¸…ç†</h1><p id="7445" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼é”€æ¯æ­¤ç¤ºä¾‹çš„ Azure åŸºç¡€æ¶æ„:</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="602f" class="md iw hi ln b fi me mf l mg mh"># Destroy this sample's Azure infrastructure using Terraform<br/>terraform destroy</span></pre><h1 id="4957" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ’™æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼</h1><p id="3b5d" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">å¦‚æœä½ è§‰å¾—è¿™æœ‰ç”¨ï¼Œä¸€äº›ğŸ‘å°†éå¸¸æ„Ÿè°¢è¿›ä¸€æ­¥ä¼ æ’­è¿™ä¸ªè¯ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨æœ‰å…¶ä»–é—®é¢˜æˆ–æƒ³æ³•ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ï¼Œæˆ–è€…åœ¨<a class="ae iu" href="https://github.com/CarlosSardo/terraform-azure-sql-automatic-tuning" rel="noopener ugc nofollow" target="_blank"> GitHub </a>ä¸­æŠ•ç¨¿ã€‚è°¢è°¢å¤§å®¶ï¼</p><h1 id="26d6" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">ğŸ“—æ¥æº</h1><p id="2b78" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated"><a class="ae iu" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/automatic-tuning-enable#enable-automatic-tuning-on-an-individual-database" rel="noopener ugc nofollow" target="_blank">åœ¨å•ä¸ªæ•°æ®åº“ä¸Šå¯ç”¨è‡ªåŠ¨è°ƒä¼˜â€” Microsoft docs </a></p></div></div>    
</body>
</html>