# Rails API ä¸­çš„ ActiveRecord::æšä¸¾éªŒè¯

> åŸæ–‡ï¼š<https://medium.com/nerd-for-tech/using-activerecord-enum-in-rails-35edc2e9070f?source=collection_archive---------0----------------------->

## *ActiveRecord::Enum* å…è®¸æ‚¨å£°æ˜ä¸€ä¸ª **enum** å±æ€§ï¼Œå…¶ä¸­çš„å€¼æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„æ•´æ•°ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åç§°è¿›è¡ŒæŸ¥è¯¢ã€‚

æœ€è¿‘ï¼Œæˆ‘ä¸€ç›´åœ¨æ„å»ºä¸€ä¸ª Rails RESTful-APIï¼Œå¹¶åœ¨ *ActiveRecord* ä¸­å‘ç°äº†`enum`ç‰¹æ€§ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä½ å¦‚ä½•ä½¿ç”¨å®ƒã€‚

![](img/0ca45c5194a43747c47cceb2d075e472.png)

blog_posts è¡¨æ¨¡å¼

æˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªéå¸¸ç®€å•çš„åšå®¢åº”ç”¨ç¨‹åºï¼Œå…¶ä¸­æˆ‘ä»¬æœ‰ä¸€ä¸ª BlogPost æ¨¡å‹æ¥å­˜å‚¨å¸–å­ã€‚
æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨`int`ä½œä¸º*çŠ¶æ€*å±æ€§çš„æ•°æ®ç±»å‹ã€‚è¿™æ˜¯å› ä¸º *ActiveRecord::Enum* åœ¨å†…éƒ¨å°†æ•°æ®å­˜å‚¨ä¸ºæ•´æ•°ï¼Œå¹¶å…è®¸æ‚¨å°†å®ƒç”¨ä½œå­—ç¬¦ä¸²ã€‚ä¼˜ç‚¹åŒ…æ‹¬éœ€è¦æ›´å°çš„å­˜å‚¨ç©ºé—´ï¼Œæ›´å¿«çš„æŸ¥è¯¢å’Œç´¢å¼•ã€‚

è®©æˆ‘ä»¬ä»ç”Ÿæˆä¸€ä¸ªä»…æ”¯æŒ API çš„åº”ç”¨ç¨‹åºå¼€å§‹ï¼Œå¹¶äº²è‡ªåŠ¨æ‰‹:

```
rails new blog --api
```

ä¸ºäº†åŠ å¿«é€Ÿåº¦ï¼Œè®©æˆ‘ä»¬æ­å»ºä¸€ä¸ªèµ„æºå¹¶è¿è¡Œè¿ç§»ä»¥å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“:

```
rails g scaffold BlogPost title content:text state:integer
rails db:migrate
```

è®©æˆ‘ä»¬å°†åšå®¢æ¨¡å‹ä¸­çš„`enum`æ·»åŠ åˆ°*çŠ¶æ€*ä¸­:

app/models/blog_post.rb

ä¸è¦å¿˜è®°è¿è¡Œ Rails æœåŠ¡å™¨`rails s`ã€‚ä½ åº”è¯¥å¯ä»¥é€šè¿‡ http://localhost:3000 è®¿é—®æœåŠ¡å™¨ã€‚

å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬è¯•ç€å†™ä¸€ç¯‡åšæ–‡ï¼Œçœ‹çœ‹æ˜¯å¦ä¸€åˆ‡éƒ½å¦‚é¢„æœŸçš„é‚£æ ·

![](img/9dfa0dc8850b8069082246bffdc7d6aa.png)

é…·ï¼å¤ªå¥½äº†ã€‚âœ¨

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡é¡ºåˆ©ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¯•å›¾å‘é€é™¤äº†ä¸º*çŠ¶æ€*æšä¸¾`[draft published]`å®šä¹‰çš„å€¼ä¹‹å¤–çš„å€¼ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬è¯•ä¸€è¯•ã€‚

![](img/86808ca71cf4f442084531b99972bbc0.png)

å“¦ï¼Œå‘¸ï¼é‚£æ˜¯ 500 ç¾å…ƒã€‚ğŸ˜•

è¿™å¾ˆå¥‡æ€ªï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥è°ƒæŸ¥ä¸€ä¸‹â€¦

æ¡†æ¶è·Ÿè¸ªå…·æœ‰ä»¥ä¸‹å¯¹è±¡:

```
{
   "exception_object_id": 31080,
   "id": 0,
   "trace": "activerecord (6.1.3.1) 
             lib/active_record/enum.rb:152:in `assert_valid_value'"
}
```

é˜…è¯»`lib/active_record/enum.rb`æºä»£ç ï¼Œç¡®åˆ‡åœ°è¯´æ˜¯`assert_valid_value`å‡½æ•°å®šä¹‰ï¼Œæˆ‘ä»¬ä¼šå‘ç°:

æºä»£ç å¤åˆ¶è‡ª[https://github . com/rails/rails/blob/main/active record/lib/active _ record/enum . Rb # L148-L152](https://github.com/rails/rails/blob/main/activerecord/lib/active_record/enum.rb#L148-L152)

è¿™æ„å‘³ç€ï¼Œåªè¦åˆ†é…ç»™ enum å±æ€§çš„å€¼åœ¨æä¾›çš„é”®ä¸­ä¸å­˜åœ¨(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ draft å’Œ published ),å°±ä¼šå¼•å‘ *ArgumentError* ã€‚

> å¯ä»¥è¯´ï¼Œrails å›¢é˜Ÿé€‰æ‹©å¼•å‘`ArgumentError`è€Œä¸æ˜¯éªŒè¯é”™è¯¯æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å®Œå…¨æ§åˆ¶ç”¨æˆ·å¯ä»¥ä»å•é€‰æŒ‰é’®ç»„ä¸­é€‰æ‹©ä»€ä¹ˆé€‰é¡¹ï¼Œæˆ–è€…å¯ä»¥åœ¨`select`å­—æ®µä¸­é€‰æ‹©ä»€ä¹ˆé€‰é¡¹ï¼Œæ‰€ä»¥å¦‚æœç¨‹åºå‘˜ç¢°å·§æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å•é€‰æŒ‰é’®ï¼Œè€Œè¯¥æŒ‰é’®çš„å€¼æœ‰ä¸€ä¸ªé”™åˆ«å­—ï¼Œé‚£ä¹ˆå¼•å‘ä¸€ä¸ªé”™è¯¯æ˜¯å¥½çš„ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºé”™è¯¯ï¼Œè€Œä¸æ˜¯ç”¨æˆ·é”™è¯¯ã€‚
> 
> ç„¶è€Œï¼Œå¯¹äº API æ¥è¯´ï¼Œè¿™æ˜¯è¡Œä¸é€šçš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†èƒ½å¤Ÿæ§åˆ¶å‘é€ç»™æœåŠ¡å™¨çš„å€¼ã€‚
> 
> â€”stack overflow[ç­”](https://stackoverflow.com/a/37184383/9329261)ä½œè€… [Jay-Ar Polidario](https://stackoverflow.com/users/3073313/jay-ar-polidario)

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•è°ƒæ•´è¿™ç§è¡Œä¸ºæ¥æ»¡è¶³æˆ‘ä»¬çš„ API éœ€æ±‚å‘¢ï¼Ÿ

æˆ‘ä»¬å°†ä¸å¾—ä¸è¦†ç›– ActiveRecord::Enum çš„`assert_valid_value`çš„è¡Œä¸ºã€‚æˆ‘ä»¬å°†é€šè¿‡ä» ActiveRecord::Enum ç»§æ‰¿ï¼Œç„¶åå°†ä¿®å¤åº”ç”¨åˆ°æ–°ç±»ä¸­çš„`assert_valid_value`æ¥é—´æ¥å®Œæˆè¿™ä¸ªä¿®å¤ã€‚

> è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ·±å—è¿™ä¸ªç­”æ¡ˆçš„å½±å“[https://stackoverflow.com/a/58416806/9329261](https://stackoverflow.com/a/58416806/9329261)ã€‚

è®©æˆ‘ä»¬é¦–å…ˆä¸ºå¯éªŒè¯çš„æšä¸¾ç±»å‹åˆ›å»ºä¸€ä¸ªç±»

app/types/validatable _ enum _ type . Rb

æˆ‘ä»¬å°†ä½¿ç”¨`***decorate_attribute_type****(column_name, decorator_name, &block)*`ã€‚

> æ­¤æ–¹æ³•æ˜¯ä¸€ä¸ªå†…éƒ¨ APIï¼Œç”¨äºåˆ›å»ºç±»å®(å¦‚ serialize)å’ŒåŠŸèƒ½(å¦‚æ—¶åŒºæ„ŸçŸ¥å±æ€§)ã€‚
> 
> ç”¨äºå°†å±æ€§çš„ç±»å‹åŒ…è£…åœ¨æ–°ç±»å‹ä¸­ã€‚å½“åŠ è½½æ¨¡å‹çš„æ¨¡å¼æ—¶ï¼Œä¸ column_name åŒåçš„å±æ€§çš„ç±»å‹å°†è®©ä½äºç»™å®šçš„å—ã€‚å°†æ”¹ä¸ºä½¿ç”¨è¯¥å—çš„è¿”å›å€¼ã€‚
> 
> â€”æ¥æº:[https://API dock . com/rails/v 6 . 0 . 0/active record/attribute decorators/class methods/decorate _ attribute _ type](https://apidock.com/rails/v6.0.0/ActiveRecord/AttributeDecorators/ClassMethods/decorate_attribute_type)

è¿™é‡Œï¼Œæˆ‘ä»¬å…è®¸ä¼ é€’å¤šä¸ªæšä¸¾æ¥åº”ç”¨æ‰€éœ€çš„è¡Œä¸ºã€‚å¯¹äºæ¯ä¸ªä¼ é€’çš„æšä¸¾ï¼Œæˆ‘ä»¬ç”¨ ValidatableEnumType åŒ…è£…å®ƒçš„æ•°æ®ç±»å‹ï¼Œå®ƒè¦†ç›–äº†æŠ›å‡º`ArgumentError`çš„`assert_valid_value`ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ BlogPost æ¨¡å‹ä¸­åŒ…å«æˆ‘ä»¬çš„å…³æ³¨ç‚¹ï¼Œå¹¶å°†æ–°çš„è¡Œä¸ºåº”ç”¨åˆ°æˆ‘ä»¬çš„ *state* enumã€‚

app/models/blog_post.rb

è®©æˆ‘ä»¬é‡è¯•ä¸Šä¸€æ¬¡å¤±è´¥çš„ POST è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªçŠ¶æ€æ— æ•ˆçš„ BlogPostï¼Œçœ‹çœ‹æ˜¯å¦ä¸€åˆ‡æ­£å¸¸

![](img/0585bf0f8b8b7dd658346ecff5261ceb.png)

å–”å–”å–”ğŸ‰ï¼

æ‚¨å¯ä»¥è½»æ¾å®šåˆ¶å‡ºé”™æ—¶è¿”å›çš„æ¶ˆæ¯

app/models/blog_post.rb

è¯•ä¸€è¯•ï¼Œçœ‹çœ‹æ¶ˆæ¯çœ‹èµ·æ¥æ€ä¹ˆæ ·

![](img/52d1f5b89e1914036c005bf49c433758.png)

å…³äºéªŒè¯é”™è¯¯çš„è‡ªå®šä¹‰æ¶ˆæ¯

å¥½å¤šäº†ï¼Œæ˜¯å§ï¼Ÿæˆ‘ä»¬è¿˜æ²¡å®Œã€‚ActiveRecord::Enum ä¸ä»…ä»…å±€é™äºå°†æ•°æ®ä»å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚

![](img/64f8dccd593f8c2c77492de9effa464e.png)

ActiveRecord::Enum çš„ç”¨æ³•

æ‚¨å°†è·å¾—ä»¥ä¸‹åŠŸèƒ½:

*   ä½¿ç”¨èŒƒå›´æŒ‰æä¾›çš„å€¼è¿›è¡ŒæŸ¥è¯¢(ä¾‹å¦‚:BlogPost.draft)
*   æ›´æ–°è®°å½•çš„æšä¸¾å€¼(ä¾‹å¦‚:BlogPost.pubilshedï¼)
*   æ£€æŸ¥æšä¸¾å€¼çš„ç›¸ç­‰æ€§(ä¾‹å¦‚:BlogPost.publishedï¼Ÿ)

ä½ å¯ä»¥åœ¨ä¸‹é¢çš„ GitHub åº“ä¸­æ‰¾åˆ°æˆ‘ä»¬å†™çš„æºä»£ç ã€‚[https://github.com/kerolloz/active-record-enum-example](https://github.com/kerolloz/active-record-enum-example)