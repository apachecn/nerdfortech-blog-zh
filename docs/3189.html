<html>
<head>
<title>Nodejs GraphQl Authentication with JWT, Apollo-server, MySql and Sequelize ORM.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nodejs GraphQl è®¤è¯ä¸ JWTï¼Œé˜¿æ³¢ç½—æœåŠ¡å™¨ï¼ŒMySql å’Œ Sequelize ORMã€‚</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/nerd-for-tech/nodejs-graphql-authentication-with-jwt-apollo-server-mysql-and-sequelize-orm-21cf1503f7f?source=collection_archive---------4-----------------------#2021-06-01">https://medium.com/nerd-for-tech/nodejs-graphql-authentication-with-jwt-apollo-server-mysql-and-sequelize-orm-21cf1503f7f?source=collection_archive---------4-----------------------#2021-06-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f057f3f8e1857c0bd123465dd1aa805d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u3IjD13EgKyfby4MD6SAmw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">æ¥è‡ª<a class="ae iu" href="https://www.pexels.com/photo/woman-writing-on-whiteboard-3861943/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>çš„<a class="ae iu" href="https://www.pexels.com/@thisisengineering?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> ThisIsEngineering </a>æ‘„å½±</figcaption></figure><p id="1a29" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨è¿‡å»çš„å‡ å¹´é‡Œï¼Œæˆ‘ä»¬è§è¯äº†å¾®æœåŠ¡æ¶æ„åœ¨ä¸€ä¸ªå®Œå…¨ä¸åŒçš„å±‚é¢ä¸Šçš„å‘å±•ã€‚å®ƒä¸“æ³¨äºå¼€å‘è½¯ä»¶ç³»ç»Ÿï¼Œè¿™äº›è½¯ä»¶ç³»ç»Ÿè¯•å›¾ä¸“æ³¨äºæ„å»ºå…·æœ‰è‰¯å¥½å®šä¹‰çš„æ¥å£å’Œæ“ä½œçš„å•ä¸€åŠŸèƒ½æ¨¡å—ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†æ•æ·ã€Devops å’Œ API çš„å¤§è§„æ¨¡å¢é•¿ã€‚ç›´åˆ°å‡ å¹´å‰ï¼Œback REST APIs è¿˜æ˜¯è¡Œä¸šæ ‡å‡†å’Œçƒ­é—¨è¯é¢˜ï¼Œä½†åœ¨ 2015 å¹´ï¼Œè„¸ä¹¦æ¨å‡ºäº† GraphQLï¼Œå¹¶åœ¨ 2018 å¹´å‘å¸ƒäº†å®ƒçš„ç¬¬ä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚æˆ‘ä¸ä¼šæ·±å…¥æ¢è®¨å®ƒï¼Œä½†è¿™é‡Œæœ‰ä¸¤ç¯‡å…³äºä¸ºä»€ä¹ˆä½¿ç”¨ Graphql çš„æ–‡ç« ã€‚<a class="ae iu" href="https://www.prisma.io/blog/top-5-reasons-to-use-graphql-b60cfa683511" rel="noopener ugc nofollow" target="_blank">ã€1ã€‘</a><a class="ae iu" rel="noopener" href="/@ajaysaini.official/why-graphql-886ba866ae75#:~:text=Here%2C%20Facebook%20team%20started%20to,to%20ask%20what%20they%20need.">ã€2ã€‘</a></p><p id="a678" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">GitHub åº“:-<a class="ae iu" href="https://github.com/foxy17/GraphQl-Authentication" rel="noopener ugc nofollow" target="_blank">https://github.com/foxy17/GraphQl-Authentication</a></p><p id="18c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä½ å¯ä»¥å¤åˆ¶è¿™ä¸ªå¹¶æŒ‰ç…§æˆ‘çš„è§£é‡Šå»åšã€‚</p><p id="de89" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨ä½¿ç”¨ JWT ä»¤ç‰Œçš„æœ¬åœ°è®¤è¯ã€‚å¯¹äºæ•°æ®åº“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½• MySql æ•°æ®åº“ã€‚Apollo-server æ˜¯ä¸€ä¸ªå¼€æºçš„ GraphQL æœåŠ¡å™¨ï¼Œå…¼å®¹ä»»ä½•ç§ç±»çš„ GraphQL å®¢æˆ·ç«¯ã€‚æˆ‘å°†ä½¿ç”¨ apollo æ¥å…¬å¼€ APIï¼Œè€Œä¸æ˜¯ expressã€‚</p><p id="94ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬å°†è¿›è¡Œä¸€ä¸ªç®€å•çš„èº«ä»½éªŒè¯ï¼Œå…¶ä¸­ç”¨æˆ·å°†æœ‰ä¸€ä¸ªåå­—ï¼Œå§“æ°ï¼Œç”µå­é‚®ä»¶ï¼Œå¯†ç ï¼Œå…¬å¸å’Œå”¯ä¸€çš„é›‡å‘˜ Idã€‚Company å°†å­˜å‚¨åœ¨å¦ä¸€ä¸ªè¡¨ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¢ç´¢ä¸ GraphQL çš„æå–å…³è”ã€‚è®©æˆ‘ä»¬é¦–å…ˆå®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…:</p><blockquote class="jt ju jv"><p id="1656" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">NPM I Apollo-server bcrpytjs dotenv JSON web token sequelize MySQL 2 graph QL</p><p id="8837" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">npm i -D åºåˆ—-cli èŠ‚ç‚¹</p></blockquote><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="088c" class="kj kk hi kf b fi kl km l kn ko">const getUser = token =&gt; {<br/>    try {<br/>        if (token) {<br/>            return jwt.verify(token, JWT_SECRET)<br/>        }<br/>        return null<br/>    } catch (error) {<br/>        return null<br/>    }<br/>}</span></pre><p id="d66c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™æ˜¯å¯¼å…¥åçš„ç¬¬ä¸€è¡Œï¼Œè¿™æ˜¯æˆ‘ä»¬å¦‚ä½•å®šä¹‰ JWT ä¸­é—´ä»¶çš„ï¼Œå®ƒå°†éªŒè¯æˆ‘ä»¬çš„ JWT ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆã€‚</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="2070" class="kj kk hi kf b fi kl km l kn ko">const server = new ApolloServer({<br/>    typeDefs,<br/>    resolvers,<br/>    context: ({ req }) =&gt; {<br/>        const token = req.get('Authorization') || ''<br/>        return { user: getUser(token.replace('Bearer', ''))}<br/>    },<br/>    introspection: true,<br/>    playground: true<br/>})<br/>server.listen({ port: PORT || 8080 }).then(({ url }) =&gt; {<br/>    console.log(`ğŸš€ Server ready at ${url}`);<br/>  });</span></pre><p id="d49a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨æ­¤ä¹‹åï¼Œæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„ Apollo æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¿…é¡»ä¼ é€’ä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„å¯¹è±¡:</p><p id="0cfd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">typeDefs:è¿™æ˜¯ graphQL API çš„æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†æˆ‘ä»¬å¯ä»¥åœ¨ API ä¸Šè°ƒç”¨çš„æŸ¥è¯¢å’Œå˜åŒ–ã€‚</p><p id="5f47" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw">è§£æå™¨:è¿™äº›æ˜¯è´Ÿè´£ä¸ºå„ä¸ª API è°ƒç”¨è¿”å›ç»“æœçš„å‡½æ•°ã€‚</em></p><p id="26a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw">ä¸Šä¸‹æ–‡:æ˜¯ä¸€ä¸ªç‰¹å®šæ‰§è¡Œçš„æ‰€æœ‰è§£æå™¨å…±äº«çš„å¯¹è±¡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»æ ‡å¤´ä¸­æ£€ç´¢ JWT ä»¤ç‰Œï¼Œå¹¶è¿è¡Œæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ getUser å‡½æ•°æ¥æ£€æŸ¥å®ƒæ˜¯å¦æœ‰æ•ˆï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ä»»ä½•è§£æå™¨éƒ½å¯ä»¥è®¿é—®çš„ç”¨æˆ·å˜é‡ä¸­ã€‚</em></p><p id="97c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw">è‡ªçœ:å®ƒå®šä¹‰äº†æˆ‘ä»¬æ˜¯å¦å¯ä»¥æŸ¥è¯¢æ¨¡å¼ï¼Œä»¥è·å¾—å…³äºå®ƒæ”¯æŒå“ªäº›æŸ¥è¯¢åŠå…¶ç»“æ„çš„ä¿¡æ¯ã€‚(é€šå¸¸åœ¨ç”Ÿäº§ä¸­æ˜¯é”™è¯¯çš„)</em></p><p id="7ba5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jw"> playground:æ˜¯ä¸€ä¸ªå›¾å½¢åŒ–çš„ã€äº¤äº’å¼çš„æµè§ˆå™¨å†…</em><strong class="ix hj"><em class="jw">graph QL</em></strong><em class="jw">IDEï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥è¿è¡ŒæŸ¥è¯¢ã€‚</em></p><p id="8adb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è®©æˆ‘ä»¬æ£€æŸ¥æˆ‘ä»¬çš„ç±»å‹å®šä¹‰æˆ–æ¨¡å¼ã€‚</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="8dd7" class="kj kk hi kf b fi kl km l kn ko">const typeDefs = gql`<br/>    input Pagination {<br/>        page: Int!<br/>        items: Int!<br/>    }<br/>    input UserFilter {<br/>        employeeId: Int<br/>        firstName: String<br/>        lastName: String<br/>    }<br/>    type User {<br/>        employeeId: Int!<br/>        firstName: String!<br/>        lastName: String!<br/>        password: String!<br/>        email: String!<br/>        company: String!<br/>    }<br/>    type AuthPayload {<br/>        token: String!<br/>        user: User!<br/>    }<br/>    type Query {<br/>        getUserList(search:UserFilter, pagination:Pagination, sort:String): [User]<br/>    }<br/>    type Mutation {<br/>        registerUser(firstName: String!, lastName: String!, employeeId: Int!, email: String!, password: String!, company: String!): AuthPayload!<br/>        login (email: String!, password: String!): AuthPayload!<br/>    }<br/>`<br/></span></pre><p id="0a91" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kp kq kr kf b">gql</code>æ¨¡æ¿æ–‡å­—æ ‡ç­¾å¯ä»¥ç”¨æ¥ç®€æ´åœ°ç¼–å†™ä¸€ä¸ª GraphQL æŸ¥è¯¢ï¼Œè¯¥æŸ¥è¯¢è¢«è§£ææˆä¸€ä¸ªæ ‡å‡†çš„ GraphQL <a class="ae iu" href="https://stackoverflow.com/questions/46163036/what-is-ast-in-graphql/46164403" rel="noopener ugc nofollow" target="_blank"> AST </a>ã€‚<code class="du kp kq kr kf b">type</code>ç”¨å…¶å‚æ•°å®šä¹‰ä¸€ä¸ªå¯¹è±¡ã€‚<code class="du kp kq kr kf b">!</code>æ ‡è®°è¡¨ç¤ºå‚æ•°æ˜¯å¼ºåˆ¶çš„ï¼Œä¸èƒ½æ˜¯æœªå®šä¹‰çš„æˆ–ç©ºçš„ã€‚æœ‰ä¸¤ç§æˆªç„¶ä¸åŒçš„ç±»å‹ï¼Œ<strong class="ix hj">æŸ¥è¯¢</strong>å’Œ<strong class="ix hj">çªå˜</strong>ã€‚ç®€å•æ¥è¯´<strong class="ix hj">æŸ¥è¯¢</strong>æ˜¯é€‰æ‹©è¯­å¥<strong class="ix hj">å˜å¼‚</strong>æ˜¯æ’å…¥æ“ä½œã€‚</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/6252dbea40e99a3bca1920509a35459b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZKAHxuZWXcgI4lRHdcYK3A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">åˆ†è§£å˜å¼‚</figcaption></figure><p id="ba76" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">é™¤äº†æ ‡é‡ç±»å‹<code class="du kp kq kr kf b">String</code>ã€<code class="du kp kq kr kf b">Int</code>ã€<code class="du kp kq kr kf b">Float</code>ã€<code class="du kp kq kr kf b">Boolean</code>å’Œ<code class="du kp kq kr kf b">ID</code>ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬ä½œä¸ºä¸€ç§ç±»å‹ç›´æ¥åˆ†é…ç»™è‡ªå˜é‡æˆ–å‚æ•°ï¼Œä¹Ÿå¯ä»¥å°†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å¤æ‚ç±»å‹ä½œä¸ºè¾“å…¥ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨è¾“å…¥æ ‡ç­¾ã€‚<code class="du kp kq kr kf b">UserFilter</code>è¾“å…¥æ˜¯ä¸€ä¸ªå®šåˆ¶è¾“å…¥ï¼Œå®ƒè¢«ä¼ é€’ä»¥è·å–ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ã€‚<code class="du kp kq kr kf b">[User]</code>æ„å‘³ç€å°†è¿”å›ä¸€ä¸ªç”¨æˆ·ç±»å‹çš„æ•°ç»„ã€‚</p><p id="da09" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ‰€æœ‰è¿™äº›éƒ½æ˜¯ GraphQL çš„ä¸»è¦å¤–å£³ï¼Œç°åœ¨å‰©ä¸‹çš„æ˜¯æ•°æ®åº“æ¨¡å‹ï¼Œå®ƒå°†æ ¹æ®æ‚¨çš„æ•°æ®åº“é€‰æ‹©å’Œè§£æå™¨å‡½æ•°è€Œå˜åŒ–ï¼Œå°±åƒæ‚¨ä¸ºç‰¹å®šè·¯å¾„ä¸Šçš„ REST API å®šä¹‰çš„å‡½æ•°ä¸€æ ·ã€‚è®©æˆ‘ä»¬çœ‹çœ‹é¡ºåºæ¨¡å‹ã€‚</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="0e66" class="kj kk hi kf b fi kl km l kn ko">//User.js<br/>module.exports = (sequelize, DataTypes) =&gt; {<br/>    const User = sequelize.define('User', {<br/>        firstName: { type: DataTypes.STRING, allowNull: true },<br/>        lastName: { type: DataTypes.STRING, allowNull: true },<br/>        email: { type: DataTypes.STRING, allowNull: false, unique: true },<br/>        password: {type: DataTypes.STRING,allowNull: false},<br/>        employeeId:{ type: DataTypes.INTEGER, allowNull: false, primaryKey: true, unique: true },<br/>    }, {timestamps: false,<br/>        hooks: {<br/>            beforeCreate: async (user) =&gt; {<br/>             if (user.password) {<br/>              const salt = await bcrypt.genSaltSync(10, 'a');<br/>              user.password = bcrypt.hashSync(user.password, salt);<br/>             }<br/>            },<br/>            beforeUpdate:async (user) =&gt; {<br/>             if (user.password) {<br/>              const salt = await bcrypt.genSaltSync(10, 'a');<br/>              user.password = bcrypt.hashSync(user.password, salt);<br/>             }<br/>            }<br/>           }<br/>    });<br/>    User.associate = function (models) {<br/>        User.hasOne(models.Company, { foreignKey: "employeeId" });<br/>      };<br/>    User.validPassword = async (password, hash) =&gt; {<br/>        return await bcrypt.compareSync(password, hash);<br/>       }<br/>    return User;<br/>  };<br/>//Company.js<br/>module.exports = (sequelize, DataTypes) =&gt; {<br/>    const Company = sequelize.define('Company', {<br/>        company: {type: DataTypes.STRING,allowNull: false},<br/>        employeeId:{ type: DataTypes.INTEGER, allowNull: false, primaryKey: true, unique: true },<br/>    }, {<br/>      timestamps: false,<br/>      freezeTableName: true,<br/>    });<br/>    Company.associate = function (models) {<br/>        Company.belongsTo(models.User, { foreignKey: "employeeId" });<br/>      };<br/>    return Company;<br/>  };</span></pre><p id="e6a3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kp kq kr kf b">beforeCreate</code>æ˜¯åœ¨è°ƒç”¨åˆ›å»ºæŸ¥è¯¢æ—¶è°ƒç”¨çš„é’©å­ã€‚é’©å­åŒ…å«ç”¨ç›æ•£åˆ—å¯†ç çš„é€»è¾‘ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šåœ¨æ•°æ®åº“ä¸­å­˜å‚¨æœªåŠ å¯†çš„å¯†ç ã€‚<code class="du kp kq kr kf b">beforeUpdate</code>å½“åœ¨ç”¨æˆ·è¡¨ä¸Šè°ƒç”¨æ›´æ–°æŸ¥è¯¢æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªé’©å­ã€‚å°±åƒä¹‹å‰ä¸€æ ·ï¼Œå®ƒæ•£åˆ—æ›´æ–°åçš„å¯†ç ã€‚<code class="du kp kq kr kf b">User.validPassword </code>æ˜¯ä¸€ä¸ªç”¨æˆ·åŠ å¯†çš„ç±»æ–¹æ³•ï¼Œç”¨æ¥æ¯”è¾ƒå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•£åˆ—å’Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä»¥æ£€æŸ¥ä¸¤è€…æ˜¯å¦ç›¸åŒã€‚<code class="du kp kq kr kf b">User.associate</code>æ˜¯ä¸å¸¦æœ‰ employeeId å¤–é”®çš„å…¬å¸è¡¨çš„ä¸€å¯¹ä¸€å…³è”ã€‚<code class="du kp kq kr kf b">Timestamp:false</code>é»˜è®¤æƒ…å†µä¸‹ï¼Œsequelize åœ¨ SQL è¡¨ä¸­åŒ…å«ä¸€ä¸ª createdAt å’Œ updateAt è®°å½•ï¼Œä½†è¿™ä¼šå°†å…¶è®¾ç½®ä¸º falseã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œsequelize ä½¿è¡¨åæˆä¸ºå¤æ•°ï¼Œè¿™ä¼šå¯¼è‡´é”™è¯¯ï¼Œé™¤éæˆ‘ä»¬é»˜è®¤è¿™æ ·è®¾ç½®å®ƒä»¬ã€‚å› ä¸ºæˆ‘æ²¡æœ‰è¿™æ ·åšï¼Œ<code class="du kp kq kr kf b">freezeTableName</code>å¸®åŠ©æˆ‘ä¿æŒè¡¨åä¸æˆ‘å®šä¹‰çš„å®Œå…¨ä¸€è‡´ï¼Œå¹¶ä¸”æ²¡æœ‰å°†<strong class="ix hj">ç”¨æˆ·æ›´æ”¹ä¸ºç”¨æˆ·</strong>æˆ–è€…å°†<strong class="ix hj">å…¬å¸æ›´æ”¹ä¸ºå…¬å¸</strong>ã€‚Index.js åªæ˜¯è¿æ¥æ•°æ®åº“çš„é»˜è®¤åºåˆ—æ–‡ä»¶ã€‚å®ƒè¿˜è·å– models æ–‡ä»¶å¤¹ä¸­å®šä¹‰çš„æ‰€æœ‰æ¨¡å‹ï¼Œå¹¶å°†å®ƒä»¬åº”ç”¨äºâ€œdbâ€å¯¹è±¡ã€‚</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="0a51" class="kj kk hi kf b fi kl km l kn ko">const resolvers = {<br/>    Query: {<br/>        async getUserList(root, args, { user }) {<br/>            try {<br/>                if(!user) throw new Error('You are not authenticated!')<br/>                const {search,pagination,sort} =args;<br/>                var query={<br/>                    offset:0,<br/>                    limit:5,<br/>                    raw: true,<br/>                    //this is done to flaten out the join command<br/>                    attributes: ['firstName','lastName','email','employeeId','Company.company',],<br/>                    include: [{ model: models.Company,attributes:[]}]<br/>                    }<br/>                    //by defaults query is paginated to limit 5 items<br/>                if(pagination){<br/>                    query.limit=pagination.items;<br/>                    query.offset=pagination.items*(pagination.page-1)<br/>                }<br/>                if(search){<br/>                    query.where={<br/>                        [Op.or]: [<br/>                            search.firstName?{ firstName: search.firstName }:null,<br/>                            search.lastName?{ lastName: search.lastName}:null,<br/>                            search.employeeId?{ employeeId: search.employeeId}:null<br/>                        ] <br/>                    }<br/>                }<br/>                if(sort){<br/>                    query.order= [<br/>                        [sort, 'ASC'],<br/>                    ];<br/>                }<br/>                return await models.User.findAll(query);<br/>            } catch (error) {<br/>                throw new Error(error.message)<br/>            }<br/>        }<br/>    },<br/><br/>    Mutation: {<br/>        async registerUser(root, { firstName, lastName, email, password, employeeId,company }) {<br/>            try {<br/>                const userCheck = await models.User.findOne({ <br/>                    where: { <br/>                        [Op.or]: [<br/>                            { email: email },<br/>                            { employeeId: employeeId }<br/>                    ] <br/>                }})<br/>                if (userCheck) {<br/>                    throw new Error('Email or Employee id already exists')<br/>                }<br/>                const user = await models.User.create({<br/>                    firstName,<br/>                    lastName,<br/>                    employeeId,<br/>                    email,<br/>                    password<br/>                })<br/>                const companyModel = await models.Company.create({<br/>                    employeeId,<br/>                    company<br/>                })<br/>                const token = jsonwebtoken.sign(<br/>                    { employeeId: user.employeeId, email: user.email},<br/>                    process.env.JWT_SECRET,<br/>                    { expiresIn: '1y' }<br/>                )<br/>                let createdUser={<br/>                    company:companyModel.company,<br/>                    employeeId: user.employeeId,<br/>                    firstName: user.firstName, <br/>                    lastName: user.lastName, <br/>                    email: user.email<br/>                }<br/><br/>                return {<br/>                    token, user:createdUser, message: "Registration succesfull"<br/>                }<br/>            } catch (error) {<br/>                throw new Error(error.message)<br/>            }<br/>        },<br/><br/>        async login(_, { email, password }) {<br/>            try {<br/>                const user = await models.User.findOne({ where: { email }})<br/><br/>                if (!user) {<br/>                    throw new Error('No user with that email')<br/>                }<br/>                const isValid = await models.User.validPassword(password, user.password)<br/>                if (!isValid) {<br/>                    throw new Error('Incorrect password')<br/>                }<br/><br/>                // return jwt<br/>                const token = jsonwebtoken.sign(<br/>                    { employeeId: user.employeeId, email: user.email},<br/>                    process.env.JWT_SECRET,<br/>                    { expiresIn: '1d'}<br/>                )<br/>                <br/>                return {<br/>                   token, user<br/>                }<br/>            } catch (error) {<br/>                throw new Error(error.message)<br/>            }<br/>        }<br/><br/>    },<br/>}</span></pre><p id="e4f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è§£æå™¨åŒ…å«ç”¨äºç›¸åº”æŸ¥è¯¢å’Œå˜å¼‚çš„å‡½æ•°ã€‚ä»–ä»¬æ¥å— 4 ä¸ªè®ºç‚¹</p><ol class=""><li id="73b2" class="kt ku hi ix b iy iz jc jd jg kv jk kw jo kx js ky kz la lb bi translated"><code class="du kp kq kr kf b">root</code>åŒ…å«ä»çˆ¶å­—æ®µçš„è§£æå™¨è¿”å›çš„ç»“æœã€‚</li><li id="c565" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated"><code class="du kp kq kr kf b">args</code>å‚æ•°ä¼ é€’åˆ°æŸ¥è¯¢ä¸­çš„å­—æ®µã€‚</li><li id="5c8b" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated"><code class="du kp kq kr kf b">context</code>ç‰¹å®šæŸ¥è¯¢ä¸­æ‰€æœ‰è§£æå™¨å…±äº«çš„å¯¹è±¡ã€‚</li><li id="e749" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated"><code class="du kp kq kr kf b">info</code>åŒ…å«å…³äºæŸ¥è¯¢çš„æ‰§è¡ŒçŠ¶æ€çš„ä¿¡æ¯ã€‚</li></ol><p id="765d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kp kq kr kf b">getUserList</code>ä¸­çš„<code class="du kp kq kr kf b">query</code>å¯¹è±¡æ˜¯ä¸€ä¸ªåŠ¨æ€å¯¹è±¡ï¼Œå®ƒæ ¹æ®ä¼ é€’ç»™æŸ¥è¯¢çš„å‚æ•°æ”¹å˜å€¼ã€‚æ‰€æœ‰å‚æ•°éƒ½æ˜¯å¯é€‰çš„ã€‚æ‰€æœ‰æŸ¥è¯¢éƒ½éœ€è¦å¸¦æœ‰æœ‰æ•ˆ jwt ä»¤ç‰Œçš„æˆæƒå¤´ã€‚è¿™æ­£ç”±<code class="du kp kq kr kf b"> if(!user) throw new Error(â€˜You are not authenticated!â€™)</code>éªŒè¯</p><p id="47e5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™æ˜¯ä»æˆ‘ä»¬ä¹‹å‰åœ¨ server.js ä¸­ä¼ é€’çš„ä¸Šä¸‹æ–‡ä¸­è·å–çš„ç”¨æˆ·å˜é‡ã€‚å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›è·¯ç”±è¢«éªŒè¯ï¼Œæˆ‘ä»¬åªéœ€åˆ é™¤è¿™ä¸€è¡Œã€‚è®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹åŸºæœ¬çš„æŸ¥è¯¢ã€‚<code class="du kp kq kr kf b">offset </code>å’Œ<code class="du kp kq kr kf b">limit</code>æ˜¯åˆ†é¡µå‚æ•°ã€‚<code class="du kp kq kr kf b">raw</code>ç”¨äºè¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª sequelize å¯¹è±¡ï¼Œè¿™æ ·æ›´å®¹æ˜“è¢« paraseã€‚å±æ€§è®©æˆ‘ä»¬å®šä¹‰å¸Œæœ›ä» SQL è¿”å›å“ªäº›åˆ—ã€‚åŒ…æ‹¬æˆ‘ä»¬å¦‚ä½•åœ¨å…¬å¸å’Œç”¨æˆ·è¡¨ä¹‹é—´åº”ç”¨è¿æ¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸èƒ½è·å–ç‰¹å®šç”¨æˆ·çš„å…¬å¸åç§°ã€‚æ‚¨ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘ä»¬å·²ç»å°† include çš„å±æ€§è®¾ç½®ä¸ºç©ºã€‚è¿™æ„å‘³ç€å°½ç®¡å®ƒä»¬å°†åœ¨æŸ¥è¯¢ä¸­è¿”å›ï¼Œä½†ä¸ä¼šæ˜¾ç¤ºã€‚å¦‚æœè¿”å›<code class="du kp kq kr kf b">{Company.company:"name",Company.employeeId:2}</code>ï¼Œå®ƒä»¬çœ‹èµ·æ¥ä¼šåƒè¿™æ ·ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬è¯•å›¾ä½¿ç”¨ graphQL æ¨¡å¼å¯¹å…¶è¿›è¡Œå¹¶è¡ŒåŒ–æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†ç”¨æˆ·å®šä¹‰ä¸ºæ‹¥æœ‰ company keyï¼Œè€Œä¸æ˜¯ Company.company ä½œä¸ºé”®ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€‰æ‹©<code class="du kp kq kr kf b">â€™Company.companyâ€™</code>ä½œä¸ºæ˜ å°„åˆ°å…¬å¸çš„ç”¨æˆ·å±æ€§ã€‚</p><p id="4f69" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è®°ä½ï¼Œå¦‚æœä½ ä½¿ç”¨ queryï¼Œä½ éœ€è¦åƒè¿™æ ·åœ¨å¤´ä¸­ä¼ é€’ JWT ä»¤ç‰Œã€‚è¯¥ä»¤ç‰Œåœ¨ç™»å½•æˆ–æ³¨å†Œæ—¶è¿”å›ã€‚</p><p id="0b67" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kp kq kr kf b">{<br/> â€œAuthorizationâ€:â€eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbXBsb3llZUlkIjoyLCJlbWFpbCI6ImJAZ21haWwuY29tIiwiaWF0IjoxNjIyNTMwNTAyLCJleHAiOjE2MjI2MTY5MDJ9.3qQOHPzhKOjM6r5JNRWoMsvyt2IzwX8aa7Bj7s1zEZwâ€<br/>}</code></p><p id="e888" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è°¢è°¢ä½ åšæŒå’Œæˆ‘åœ¨ä¸€èµ·ï¼Œå¦‚æœä½ å–œæ¬¢è¿™ä¸ªå¹¶ä¸”æƒ³çœ‹æ›´å¤šçš„ä¸œè¥¿ï¼Œä½ å¯ä»¥<strong class="ix hj"> star </strong>æˆ–è€…<strong class="ix hj">fork</strong>GitHub repoã€‚</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/0027d2d61204fa3e1060b194093e2221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1qvxGJgDNqWCuzDCwD5iiQ.jpeg"/></div></div></figure><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/cb9a430be380e286e47c5d31f3ecf142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8oPLSdxxd9Gc7rDB7n6riQ.jpeg"/></div></div></figure><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/c13a42bdf58f9fe3744e116caa610c4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dFVLr_gTLX4WMOSU3GyDag.jpeg"/></div></div></figure></div></div>    
</body>
</html>