# 2021 å¹´ Android å®‰å…¨æ”¹é€ è°ƒç”¨ kotlin ååŒç¨‹åºæ‰©å±•â€”ç¬¬ä¸€éƒ¨åˆ†

> åŸæ–‡ï¼š<https://medium.com/nerd-for-tech/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-i-d47e9e2962ad?source=collection_archive---------3----------------------->

![](img/09009555fe6b4edbfcba051efa70e842.png)

ç…§ç‰‡ç”± [Fotis Fotopoulos](https://unsplash.com/@ffstop?utm_source=medium&utm_medium=referral) åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

ä½ å¥½ğŸ‘‹ï¼Œä»Šå¤©æˆ‘å°†æ•™ä½ å¦‚ä½•ä»¥ä¸€ç§å®‰å…¨å’Œ kotlin æƒ¯ç”¨çš„æ–¹å¼æ‰§è¡Œç½‘ç»œå‘¼å«ã€‚åœ¨è¿™ä¸ªå°ç³»åˆ—çš„ç»“å°¾ï¼Œæ‚¨å¯èƒ½ä¼šçœ‹åˆ°è¿™æ ·çš„å†…å®¹:

ä»æ•°æ®å±‚åˆ°é¢†åŸŸå±‚å’Œè¡¨ç¤ºå±‚ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¶æ„ç»“æ„ã€‚

ä»¥ä¸Šè¦ç‚¹æ˜¯å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨æ‚¨çš„ ViewModel / Presenter/ etc ä¸­æ‰§è¡Œæ”¹é€ å‘¼å«å¹¶å¤„ç†å¤±è´¥æˆ–æˆåŠŸçš„ç»“æœã€‚
å¦‚æœä½ ä¸æ˜ç™½è¦ç‚¹çš„å†…å®¹ï¼Œä¸è¦æ‹…å¿ƒï¼Œæˆ‘ä¼šä¸€æ­¥ä¸€æ­¥åœ°åšä¸€ä¸ªéå¸¸ç®€å•ä½†å…·ä½“çš„è§£é‡Šã€‚

å¦‚æœä½ æƒ³ç›´æ¥çœ‹ä»£ç ï¼Œçœ‹çœ‹æˆ‘åšçš„è¿™ä¸ªå…³äºç”µå½±çš„æ¸¸ä¹åœºé¡¹ç›®ã€‚

[](https://github.com/ChristopherME/movies-android) [## Christopher me/ç”µå½±-android

### Movies æ˜¯ä¸€ä¸ªç®€å•çš„é¡¹ç›®ï¼Œå¯ä»¥å­¦ä¹ å’Œä½¿ç”¨ä¸€äº› android ç»„ä»¶ã€æ¶æ„å’Œ Android å·¥å…·â€¦

github.com](https://github.com/ChristopherME/movies-android) 

# æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

é¦–å…ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦åç¨‹æ¥æ‰§è¡Œç½‘ç»œè°ƒç”¨(ä½¿ç”¨ retrofit æˆ–ä»»ä½•å…¶ä»– HTTP å®¢æˆ·ç«¯)ï¼Ÿæˆ‘çš„æœ‹å‹ï¼Œæ­£å¦‚ä½ å·²ç»çŸ¥é“çš„(æˆ–è€…å¯èƒ½ä¸çŸ¥é“),å½“ä½ å¯åŠ¨ä½ çš„ android åº”ç”¨ç¨‹åºæ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Linux è¿›ç¨‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹(ä¸»çº¿ç¨‹æˆ–è€… UI çº¿ç¨‹ï¼Œå¦‚æœä½ æ„¿æ„çš„è¯)ã€‚è¿™ä¸ªçº¿ç¨‹è´Ÿè´£ç»˜åˆ¶è§†å›¾ç»„ä»¶ã€å°éƒ¨ä»¶ç­‰ã€‚ä¸ UI ç›¸å…³çš„ä¸€åˆ‡ã€‚å®Œå…¨ç¦æ­¢åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šåšå…¶ä»–äº‹æƒ…ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå¯èƒ½ä¼šå´©æºƒã€‚æŸ¥çœ‹å®˜æ–¹[æ–‡æ¡£](https://developer.android.com/guide/components/processes-and-threads#Threads)äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬ä¸å…è®¸åœ¨ UI çº¿ç¨‹ä¸Šæ‰§è¡Œç¹é‡çš„ä»»åŠ¡ï¼Œå¦‚ç½‘ç»œè°ƒç”¨ã€æ•°æ®åº“æ“ä½œã€è¯»/å†™æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä¼šå˜æ…¢ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ° [ANR](https://developer.android.com/training/articles/perf-anr#anr) å¼‚å¸¸ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šå´©æºƒã€‚

# æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å—ï¼Ÿ

åœ¨æ—§çš„ android ç¼–ç æ—¶ä»£ï¼Œäººä»¬ä¹ æƒ¯äºåˆ›å»ºè‡ªå·±çš„çº¿ç¨‹æ± ï¼Œå¹¶è‡ªå·±ç®¡ç†çº¿ç¨‹çš„åˆ›å»ºå’Œç»´æŠ¤ğŸ¤¯ï¼ç›¸ä¿¡æˆ‘ï¼Œå­©å­ï¼Œè¿™ä¸æ˜¯ä½ æƒ³åšçš„äº‹ã€‚å…¶ä»–è§£å†³æ–¹æ¡ˆæš—ç¤º [AsyncTasks](https://developer.android.com/reference/android/os/AsyncTask) ä¸å¤ªçµæ´»ï¼Œç°åœ¨å·²è¢«å¼ƒç”¨ã€‚é‚£äº›çœŸå®çš„è™½ç„¶å²æœˆã€‚æˆ‘å¯¹é‚£äº›å¼€å‘ android åº”ç”¨ç¨‹åºçš„å¼€å‘è€…è¡¨ç¤ºæ•¬æ„ã€‚

ç„¶åï¼Œä½œä¸ºä¸€ä¸ªä¸æ–­æ¼”å˜çš„å¹³å°ï¼ŒæŒ‘æˆ˜å’Œå…‹æœè¿™äº›æŒ‘æˆ˜çš„æ–¹æ³•éœ€è¦æ–°çš„å’Œæ›´çµæ´»çš„æ–¹æ³•ã€‚é‚£æ—¶ RxJava æ˜¯ Android åº”ç”¨ç¨‹åºçš„æ–°æ•‘ä¸–ä¸»ã€‚RxJava å¯¹äºå¼‚æ­¥ä»»åŠ¡æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰è‡ªå·±çš„ç¼ºé™·:

*   æ¼«é•¿çš„å­¦ä¹ è¿‡ç¨‹ã€‚ç¬¬ä¸€æ¬¡ç†è§£èµ·æ¥å¹¶ä¸å®¹æ˜“ï¼Œå› ä¸ºä½ å¿…é¡»å°†ä½ çš„æ€ç»´æ¨¡å¼è½¬å˜ä¸ºä¸€ç§ååº”å¼ç¼–ç¨‹ï¼Œæœ‰å¾ˆå¤šæ“ä½œç¬¦å’Œé©¬è´å°”å›¾ğŸ˜µã€‚
*   å®ƒç»™ä½ æœ€ç»ˆçš„ APK å°ºå¯¸å¢åŠ äº† 2MB ä»¥ä¸Š
*   è¿™å°±åƒç”¨ç«ç®­ç­’æ‰“æ­»ä¸€åªè™«å­ã€‚æ‚¨å¯èƒ½ä¸ä¼šä½¿ç”¨è¯¥åº“ä¸­ 50%çš„å®ç”¨ç¨‹åºï¼Œè€Œåªä¼šå°†å®ƒç”¨äºä¸€ä¸ªé—®é¢˜ï¼Œå³å¼‚æ­¥ä»»åŠ¡ã€‚

# æ•‘æ´åç®¡å‘˜

2017 å¹´ï¼Œè°·æ­Œæ­£å¼å°† Kotlin ç”¨äº Android å¼€å‘ï¼Œæ­¤åäº‹æƒ…å‘å±•å¾—éå¸¸å¿«ã€‚ä»–ä»¬åœ¨è¯¥è¯­è¨€çš„ 1.1 ç‰ˆæœ¬ä¸­ä¸ºå¼‚æ­¥ä»»åŠ¡æä¾›äº†ä¸€ä¸ªé›†æˆçš„è§£å†³æ–¹æ¡ˆï¼Œå³è‘—åçš„åç¨‹ã€‚å¯¹äºé‚£äº›ç”¨ Kotlin ç¼–ç çš„äººæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆï¼

> *åç¨‹*æ˜¯å¯æŒ‚èµ·è®¡ç®—çš„ä¸€ä¸ªå®ä¾‹ã€‚å®ƒåœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºä¸€ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ªä»£ç å—ä¸å…¶ä½™ä»£ç åŒæ—¶è¿è¡Œã€‚ç„¶è€Œï¼Œåç¨‹å¹¶ä¸ç»‘å®šåˆ°ä»»ä½•ç‰¹å®šçš„çº¿ç¨‹ã€‚å®ƒå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æš‚åœæ‰§è¡Œï¼Œç„¶ååœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ç»§ç»­æ‰§è¡Œã€‚
> 
> åç¨‹å¯ä»¥è¢«è®¤ä¸ºæ˜¯è½»é‡çº§çš„çº¿ç¨‹ï¼Œä½†æ˜¯æœ‰è®¸å¤šé‡è¦çš„åŒºåˆ«ä½¿å¾—å®ƒä»¬åœ¨ç°å®ç”Ÿæ´»ä¸­çš„ç”¨æ³•ä¸çº¿ç¨‹éå¸¸ä¸åŒã€‚
> 
> [ç§‘ç‰¹æ—æ–‡ä»¶](https://kotlinlang.org/docs/coroutines-basics.html#your-first-coroutine)

# è®©æˆ‘ä»¬ä¸€èµ·æŠŠå®ƒåŒ…èµ·æ¥

ä¸ºäº†å®‰å…¨åœ°æ‰§è¡Œç½‘ç»œå‘¼å«ï¼Œæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹äº‹æƒ…:

*   **ç¡®ä¿å®ƒæ²¡æœ‰åœ¨ä¸»çº¿ç¨‹**ä¸­æ‰§è¡Œâ€”â€”åç¨‹[è°ƒåº¦ç¨‹åº](https://developer.android.com/kotlin/coroutines/coroutines-adv?hl=es-419)å°†æˆä¸ºæˆ‘ä»¬è¿™é‡Œçš„å·¥å…·ã€‚
*   æˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦**è§£æä¸€äº›åç«¯é”™è¯¯å“åº”**â€”â€”æˆ‘ä»¬å°†ä½¿ç”¨ [Moshi](https://github.com/square/moshi) è§£æ JSONã€‚
*   å¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ æŸç§ä¸­é—´ä»¶åŠŸèƒ½ï¼Œä»¥ä¾¿**ä»…åœ¨æ‰€æœ‰è¿™äº›ä¸­é—´ä»¶éƒ½æ»¡è¶³æ¡ä»¶çš„æƒ…å†µä¸‹æ‰§è¡Œæˆ‘ä»¬çš„ç½‘ç»œè°ƒç”¨**ã€‚â€”è¿™æ˜¯å¯é€‰çš„ã€‚

æˆ‘ä»¬å¾—åˆ°äº†å¯¹ç½‘ç»œè°ƒç”¨æ‰©å±•åŒ…è£…å™¨çš„è¦æ±‚ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ‚¬è€Œæœªå†³â€¦â€¦å¦‚ä½•ç”¨åç¨‹å¤„ç†å¼‚å¸¸ğŸ¤”ï¼Ÿ

ä½¿ç”¨`try catch`å—éå¸¸ç›´æ¥åœ°å¤„ç†å¼‚å¸¸ã€‚çœ‹çœ‹è¿™ç¯‡æ¥è‡ª [Manuel Vivo](https://medium.com/u/3b5622dd813c?source=post_page-----d47e9e2962ad--------------------------------) çš„[åšå®¢](/androiddevelopers/exceptions-in-coroutines-ce8da1ec060c)è°ˆè®ºå®ƒã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬è¿˜å°†ä½¿ç”¨ä¸€ä¸ª try catch å—æ¥å¤„ç†æˆ‘ä»¬çš„å¼‚å¸¸ğŸ¤«ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸ä¼šé€šè¿‡åº”ç”¨ç¨‹åºçš„å„ä¸ªå±‚ä¼ é€’å¼‚å¸¸ã€‚

ç›¸åï¼Œæˆ‘ä»¬å°†ä¼ é€’åŒ…è£…åœ¨ awsome " [è¦ä¹ˆ](https://github.com/ChristopherME/movies-android/blob/master/functional-programming/src/main/java/com/christopher_elias/functional_programming/Either.kt)"ç±»ä¸­çš„è‡ªå®šä¹‰[æ•…éšœ](https://github.com/ChristopherME/movies-android/blob/master/functional-programming/src/main/java/com/christopher_elias/functional_programming/Failure.kt)(æ‚¨ç”šè‡³å¯ä»¥åœ¨ google ç¤ºä¾‹ä¸­æ‰¾åˆ°ç±»ä¼¼çš„å®ç°ï¼Œå°±åƒè¿™ä¸ª[ç»“æœ](https://github.com/google/iosched/blob/main/shared/src/main/java/com/google/samples/apps/iosched/shared/result/Result.kt)å¯†å°ç±»)ã€‚

è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯ä¸€ä¸ªå¯†å°çš„ç±»ï¼Œåœ¨ç»™å®šçš„æ—¶é—´é‡Œå¯ä»¥æ˜¯ä¸€ä¸ªé”™è¯¯æˆ–æˆåŠŸçš„å¯¹è±¡ã€‚å®ƒè¿˜åŒ…å«ä¸€äº›æˆ‘å®ç°çš„é¢å¤–æ–¹æ³•ï¼Œç”¨äºåŸºäº[ç®­å¤´](https://github.com/arrow-kt/arrow)å‡½æ•°ç¼–ç¨‹åº“æ‰§è¡ŒæŸç§æ˜ å°„æ“ä½œã€‚è¿™ä¸¤ç§è¯¾éƒ½ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ï¼Œæˆ‘æ˜¯åœ¨é˜…è¯»è´¹å°”å—å¤šÂ·åˆ‡å“ˆæ–¯çš„è¿™ç¯‡ä»¤äººæƒŠå¹çš„æ–‡ç« æ—¶å‘ç°çš„ã€‚

å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯å¯†å°ç±»ï¼Œçœ‹çœ‹å¼—æ´›é‡Œçº³Â·èŠ’ç‰¹å†…æ–¯åº“çš„è§†é¢‘

æˆ‘ä»¬å·²ç»å»ºç«‹äº†åŸºç¡€ï¼Œè¯¥ç¼–ç äº†ã€‚æŸ¥çœ‹ç¬¬ 2 éƒ¨åˆ†ğŸ‘‰[æ­¤å¤„](https://christopher-elias.medium.com/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-ii-fd55842951cf)ã€‚