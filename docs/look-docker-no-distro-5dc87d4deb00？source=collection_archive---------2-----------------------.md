# çœ‹ç å¤´ï¼Œæ²¡æœ‰å‘è¡Œ

> åŸæ–‡ï¼š<https://medium.com/nerd-for-tech/look-docker-no-distro-5dc87d4deb00?source=collection_archive---------2----------------------->

*è¿™æ˜¯å››ç¯‡ç³»åˆ—æ–‡ç« ä¸­çš„ç¬¬äºŒç¯‡ï¼Œå°½é‡å‡å°‘&ä¿æŠ¤ Docker å›¾åƒã€‚æŸ¥çœ‹è¯¥ç³»åˆ—çš„å…¶ä»–æ–‡ç« :
1ã€‚* [*å˜å¤§ã€‚dockerignoreï¼Œæ›´å°çš„ Docker å›¾ç‰‡*](/nerd-for-tech/bigger-dockerignore-smaller-docker-images-49fa22e51c7) *2ã€‚* [*çœ‹ Dockerï¼ŒNo Distro*](/nerd-for-tech/look-docker-no-distro-5dc87d4deb00)

ä½¿ç”¨ Docker æ—¶ï¼Œ(å›¾åƒ)å¤§å°å¾ˆé‡è¦ã€‚è¾ƒå°çš„æ˜ åƒå¤§å°å…è®¸æˆ‘ä»¬åœ¨ä¿æŒè¾ƒå°ç£ç›˜å¤§å°çš„åŒæ—¶ï¼ŒåŠ é€Ÿå’Œç¼–æ’å‡ ååˆ°å‡ ç™¾ä¸ªå®¹å™¨ã€‚è¾ƒå°çš„å›¾åƒå¤§å°ä¹Ÿå‡å°‘äº†å®¹å™¨çš„æ”»å‡»é¢ï¼Œä¿æŠ¤äº†åº”ç”¨ç¨‹åºå’Œæ•°æ®ã€‚é€šè¿‡å‡å°ç£ç›˜å¤§å°å’Œæ”»å‡»é¢ï¼Œæˆ‘ä»¬èŠ‚çœäº†èµ„é‡‘ã€‚å› æ­¤ï¼Œé€šè¿‡ç¼©å° Docker å›¾åƒå°ºå¯¸ï¼Œæˆ‘ä»¬é™ä½äº†æˆæœ¬ã€‚

![](img/35c5212ea568771e281d51198a6bc857.png)

è¿™æ˜¯å››ç¯‡ç³»åˆ—æ–‡ç« ä¸­çš„ç¬¬äºŒç¯‡ã€‚è®©æˆ‘ä»¬è®¾å®šä¸€äº›æœŸæœ›ã€‚å¯¹äºè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å‡è®¾ä½ å·²ç»ç†Ÿæ‚‰äº†`.dockerignore`ã€‚å°½ç®¡æˆ‘ä»¬å°†ä½¿ç”¨`.dockerignore`ï¼Œä½†æˆ‘ä»¬ä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´å…³æ³¨å®ƒã€‚å¦‚æœä½ æƒ³æ·±å…¥äº†è§£`.dockerignore`ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºå‡å°‘æ— å‘è¡Œç‰ˆæ˜ åƒçš„åŸºæœ¬æ˜ åƒå¤§å°ï¼Œåˆ é™¤ä¸å¿…è¦çš„ä¾èµ–é¡¹ï¼Œä»¥åŠå¤šé˜¶æ®µæ„å»ºã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä¿æŠ¤ Docker å›¾åƒå’Œ Docker æ–‡ä»¶ã€‚å°±ç›®å‰è€Œè¨€ï¼Œç®€å•åœ°ç¼©å°å›¾åƒå¤§å°(è¿›è€Œç¼©å°æ”»å‡»é¢)å°†ä½¿æˆ‘ä»¬æœç€æé«˜å®‰å…¨æ€§çš„æ–¹å‘å‰è¿›ã€‚

# ğŸ¦¹å°å‘è¡Œç‰ˆæ‹¯æ•‘ä¸–ç•Œ

é€šè¿‡æŒ‡å®šæ ‡ç­¾ç‰ˆæœ¬`golang:1.16`æˆ–é€šè¿‡æ‹‰æœ€æ–°ç‰ˆæœ¬`golang`æ¥æ‹‰ Docker å›¾åƒå°†äº§ç”Ÿä¸`golang:1.16-buster`ç›¸åŒçš„ç»“æœã€‚å¦‚ä½ æ‰€è§ï¼Œè¿™ä¸‰ä¸ªéƒ½å…±äº«äº†`b09f7387a719`çš„å›¾åƒ IDã€‚Buster æ˜¯ Debian æœ€æ–°ç¨³å®šç‰ˆæœ¬ 10.9 çš„ä»£å·ã€‚é™¤éä½ ç‰¹åˆ«éœ€è¦è¿™ä¸ªå›¾åƒï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒæ˜¯ä¸å¿…è¦çš„ã€‚ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼ŒAlpineï¼Œæ˜¯ä¸€ä¸ªè¾ƒå°çš„ Linux å‘è¡Œç‰ˆï¼Œç”¨ä½œåŸºæœ¬æ˜ åƒã€‚

Alpine Golang å›¾åƒçš„é‡é‡ä¸º`302MB`ï¼Œè€Œ Debian å›¾åƒçš„é‡é‡æ˜¯å®ƒçš„ 2.85 å€ã€‚æˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç£ç›˜ç©ºé—´è¿è¡Œå’Œç¼–æ’ 2.85 å€å¤šçš„å®¹å™¨ã€‚

ä½¿ç”¨ [Snyk](https://synk.io) ï¼Œæˆ‘ä»¬å¯ä»¥æ‰«æ Docker å›¾åƒå¯»æ‰¾æ¼æ´ã€‚`golang:1.16-debian`æœ‰ [164 ä¸ªå·²çŸ¥æ¼æ´ï¼Œå…¶ä¸­ 14 ä¸ªä¸ºé«˜ä¸¥é‡æ€§](https://snyk.io/test/docker/golang%3A1.16-buster)ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ`golang:1.16-alpine` Docker é•œåƒæœ‰ [0 ä¸ªå·²çŸ¥æ¼æ´](https://snyk.io/test/docker/golang%3A1.16-alpine)ã€‚ç„¶è€Œï¼Œè¿™ä»…ä»…æ˜¯å¼€å§‹ã€‚

é—®é¢˜æ˜¯æˆ‘ä»¬çœ‹é—®é¢˜çš„è§’åº¦ä¸å¯¹ã€‚å¦‚æœæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å‡å°‘å›¾åƒå¤§å°ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å¯»æ‰¾è¶Šæ¥è¶Šå°çš„å‘è¡Œç‰ˆï¼Ÿæˆ‘ä»¬å‘ç°çš„ä»»ä½•å‘è¡Œç‰ˆéƒ½å¿…ç„¶ä¼šæœ‰æˆ‘ä»¬ä¸éœ€è¦çš„åŒ…ã€‚è¿™äº›è½¯ä»¶åŒ…å ç”¨äº†ç£ç›˜ç©ºé—´ï¼Œå½“ç„¶ä¹Ÿæœ‰å®ƒä»¬è‡ªå·±çš„æ¼æ´ã€‚ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥ä»å¤´å¼€å§‹å»ºç«‹å½¢è±¡ã€‚å°±åƒä¸€ä¸ªè€çˆ·è½¦çˆ±å¥½è€…ä¸€æ ·ï¼Œä»–ç¡®åˆ‡åœ°çŸ¥é“ä»–çš„è½¦é‡Œæœ‰ä»€ä¹ˆï¼Œæˆ‘ä»¬å°†å»ºç«‹æˆ‘ä»¬çš„ Docker å›¾åƒï¼Œç¡®åˆ‡åœ°çŸ¥é“é‡Œé¢æœ‰ä»€ä¹ˆã€‚

![](img/1412e285c926eb0a3dafc5a23d2e1588.png)

# ğŸ”§è¯¥é¡¹ç›®

æˆ‘ä»¬å°†æ„å»ºçš„å±•ç¤ºå°å‹ Docker å›¾åƒçš„åº”ç”¨ç¨‹åºå°†æ˜¯ä¸€ä¸ªç®€å•çš„ APIï¼Œåªæœ‰ä¸€æ¡è·¯çº¿ã€‚å¯¹`/`è·¯ç”±çš„`GET`è¯·æ±‚å°†å¯¹è¿›è¡Œ API è°ƒç”¨ï¼Œä»¥è·å–ç”¨æˆ·çš„ IP åœ°å€ã€ISP å’Œä½ç½®æ•°æ®ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„çº¬åº¦å’Œç»åº¦ï¼Œç²¾ç¡®åˆ°ç™¾ä¸‡åˆ†ä¹‹ä¸€ã€‚æ‰€æœ‰è¿™äº›æ•°æ®éƒ½å°†è¢«è¿”å›ã€‚

å¦‚æœæ‚¨æƒ³ä¸‹è½½ä»£ç å¹¶äº²è‡ªè¯•ç”¨ï¼Œæ‚¨éœ€è¦ä»ä»¥ä¸‹ç½‘å€æ³¨å†Œä¸€ä¸ªå…è´¹çš„ API å¯†åŒ™:

```
[https://geo.ipify.org](https://geo.ipify.org/)/
```

æ¯ç§è¯­è¨€çš„å­˜å‚¨åº“é“¾æ¥å¦‚ä¸‹:

*   ğŸ€[æˆˆæœ—](https://github.com/starlightromero/distroless-go-ip)
*   ğŸš® [JavaScript](https://github.com/starlightromero/distroless-node-ip)
*   ğŸ [Python](https://github.com/starlightromero/distroless-python-ip)

# ğŸï¸ä»é›¶å¼€å§‹

Scratch æ˜¯ Docker å®¹å™¨æœ€ç²¾ç®€çš„ç‰ˆæœ¬ã€‚é™¤äº†æ‚¨æ·»åŠ åˆ°å…¶ä¸­çš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¹‹å¤–ï¼ŒScratch ä¸­ä¸åŒ…å«ä»»ä½•å†…å®¹ã€‚å®ƒæ²¡æœ‰å¤–å£³ï¼Œæ²¡æœ‰å¤šä½™çš„ä¸œè¥¿ã€‚

## æˆˆæœ—

ç”±äº Golang æ˜¯ä¸€ç§ç¼–è¯‘è¯­è¨€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤šé˜¶æ®µæ„å»ºä¸­ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶åŸºç¡€æ˜ åƒã€‚æˆ‘ä»¬è¿˜å°†ä»¥å„ç§å…¶ä»–æ–¹å¼æ„å»º Golang ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åº:

*   å·´æ–¯ç‰¹å•çº§åˆ¶é€ 
*   å·´æ–¯ç‰¹å¤šé˜¶æ®µå»ºé€ 
*   é˜¿å°”å‘æ–¯å•é˜¶æ®µå»ºé€ 
*   é˜¿å°”å‘æ–¯å¤šé˜¶æ®µå»ºç­‘
*   åˆ†å¸ƒå¼å¤šé˜¶æ®µæ„å»º

## å•çº§ä¸å¤šçº§

ä½ å¯èƒ½è§è¿‡è¿™æ ·çš„ docker æ–‡ä»¶â€¦

```
FROM ...
WORKDIR ...
COPY ...
CMD ...
```

ç„¶è€Œï¼Œå¤šé˜¶æ®µæ„å»ºå…è®¸æˆ‘ä»¬é€šè¿‡æœ‰é€‰æ‹©åœ°å°†å·¥ä»¶ä»ä¸€ä¸ªåŸºç¡€å›¾åƒå¤åˆ¶åˆ°å¦ä¸€ä¸ªåŸºç¡€å›¾åƒæ¥ä¼˜åŒ–å’Œå‡å°å›¾åƒçš„å¤§å°ã€‚å½“æˆ‘ä»¬åˆ†æä¸Šé¢é“¾æ¥çš„ä¸åŒå›è´­çš„ docker æ–‡ä»¶æ—¶ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°ä¸€äº›å¤šé˜¶æ®µæ„å»ºçš„ç¤ºä¾‹ã€‚

ä¸‹é¢é“¾æ¥çš„æ–‡ç« æ·±å…¥æ¢è®¨äº†å¤šé˜¶æ®µæ„å»ºã€‚æˆ‘çš„æ„å»ºä»æœªå¦‚æ­¤æç«¯ï¼Œä½†æˆ‘å¯ä»¥çœ‹åˆ°å®ƒçš„ç”¨ä¾‹ã€‚

[](/capital-one-tech/multi-stage-builds-and-dockerfile-b5866d9e2f84) [## ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºæ¥ç®€åŒ–å’Œæ ‡å‡†åŒ–æ„å»ºè¿‡ç¨‹

### ä½¿ç”¨æœ¬æœº Dockerfile å·¥å…·å‘å·¦ç§»åŠ¨ä¿¡æ¯å¹¶åŠ å¿«äº¤ä»˜é€Ÿåº¦

medium.com](/capital-one-tech/multi-stage-builds-and-dockerfile-b5866d9e2f84) 

ä»ä¸Šé¢é“¾æ¥çš„æ–‡ç« ä¸­æ‘˜å½•çš„ä¸€å°æ®µå†…å®¹æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„è§£é‡Š:

> å¤šé˜¶æ®µæ„å»ºå…è®¸æ‚¨å°†éœ€è¦å•ç‹¬ docker æ–‡ä»¶çš„æ„å»ºã€æµ‹è¯•å’Œè¿è¡Œæ—¶ç¯å¢ƒåˆ†å¼€ã€‚å®ƒä»¬å…è®¸æ‚¨æœ€å°åŒ–æ‚¨éƒ¨ç½²çš„æœ€ç»ˆ Docker å®¹å™¨çš„å®é™…å¤§å°ï¼Œå› ä¸ºå„ç§å±‚ä¸å†å­˜å‚¨åœ¨æœ€ç»ˆå®¹å™¨ä¸­ã€‚

## åˆ®ç—•çš„ç¼ºç‚¹

ä½¿ç”¨ä¸´æ—¶å›¾åƒæœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼›å®ƒä»¬åªé€‚ç”¨äºç¼–è¯‘è¯­è¨€ï¼Œåœ¨ç¼–è¯‘è¯­è¨€ä¸­ï¼Œä»£ç å¯ä»¥è¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶ï¼Œç„¶åè¢«æ‰§è¡Œã€‚å¯¹äºåŒ…æ‹¬ JavaScript å’Œ Python åœ¨å†…çš„è®¸å¤šè¯­è¨€æ¥è¯´ï¼Œå®ƒä»¬æ˜¯è¢«è§£é‡Šçš„è€Œä¸æ˜¯è¢«ç¼–è¯‘çš„ T2ï¼Œä¸€ä¸ªä¸´æ—¶æ˜ åƒæ˜¯ä¸èµ·ä½œç”¨çš„ã€‚æš‚å­˜æ˜ åƒçš„å®¹å™¨å°†ä¸èƒ½æ‰§è¡Œä»£ç ï¼Œå› ä¸ºå®ƒä¸æ˜¯æœºå™¨å¯è¯»çš„ä»£ç ï¼Œå› æ­¤éœ€è¦è§£é‡Šå™¨ã€‚ç„¶è€Œï¼Œå¦‚å‰æ‰€è¿°ï¼Œä¸´æ—¶æ˜ åƒæ²¡æœ‰è§£é‡Šå™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºå®¹å™¨ã€‚

## åˆ®åˆ®ä¹çš„æ›¿ä»£å“

å¯¹äºä¸æ˜¯ç”¨ç¼–è¯‘è¯­è¨€ç¼–å†™çš„ç¨‹åºæ¥è¯´ï¼Œç¼©å°å›¾åƒå¤§å°æ˜¯æœ‰å¸Œæœ›çš„ã€‚[distroles images](https://github.com/GoogleContainerTools/distroless)å¤§çº¦åœ¨ 2017 å¹´é—®ä¸–ã€‚ä¸€ä¸ªæ— å‘è¡Œç‰ˆçš„æ˜ åƒå¹¶ä¸åƒ scratch é‚£æ ·æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ˜ åƒæ¥è§£å†³é—®é¢˜ã€‚ç›¸åï¼Œå‘è¡Œç‰ˆæ˜ åƒæ˜¯ä¸€ç±»æœ€å°æ˜ åƒï¼ŒåªåŒ…å«æ‚¨çš„åº”ç”¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶ä¾èµ–é¡¹ã€‚

é™æ€æ— å‘è¡Œç‰ˆå›¾åƒ`gcr.io/distroless/static`æ˜¯æ‰€æœ‰æ— å‘è¡Œç‰ˆå›¾åƒä¸­æœ€ç®€å•çš„ã€‚å®ƒåŒ…å«ä¸€ä¸ªæœ€å°çš„åŸºäº Linuxã€glibc çš„ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå…·æœ‰:

*   ğŸ“ca è¯ä¹¦
*   ğŸ”’root ç”¨æˆ·çš„/etc/passwd æ¡ç›®
*   ğŸ—‘ï¸ A /tmp ç›®å½•
*   âŒšÂ·èŒ¨ data

åŒæ ·ï¼Œ*é™æ€*å›¾åƒæ˜¯æœ€ç®€å•çš„æ— åˆ†å¸ƒå›¾åƒã€‚åœ¨é™æ€æ˜ åƒçš„åŸºç¡€ä¸Šå¢åŠ äº†æ›´å¤šçš„åŒ…ï¼Œè¿™å°±æ˜¯åŸºæœ¬æ˜ åƒã€‚(è¿·æƒ‘å¯¹å—ï¼Ÿï¼)

## å·²ç¼–è¯‘çš„æš‚å­˜

å¯¹äºç¼–è¯‘è¯­è¨€ï¼Œæ¯”å¦‚ Golangï¼Œå‘è¡Œç‰ˆå®¹å™¨ä»ç„¶æœ‰å¥½å¤„ã€‚æ¯”è¾ƒä¸´æ—¶ docker æ–‡ä»¶å’Œåˆ†å¸ƒå¼ docker æ–‡ä»¶ã€‚

å¯¹äºä¸´æ—¶åŸºç¡€æ˜ åƒï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨æ·»åŠ  CA è¯ä¹¦ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬ä»¥ root èº«ä»½è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ç”šè‡³æ²¡æœ‰ä¸€ä¸ª shell å¯ä»¥è®©`docker exec`è¿›å…¥ï¼Œç„¶è€Œ Docker å®‰å…¨çš„ç¬¬ä¸€æ¡è§„åˆ™æ˜¯ï¼Œ**æ°¸è¿œä¸è¦ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œä½ çš„åº”ç”¨ç¨‹åºã€‚**

æœ‰äº†å‘è¡Œç‰ˆåŸºç¡€æ˜ åƒï¼Œæˆ‘ä»¬ä¸å¿…æ‰‹åŠ¨æ·»åŠ  CA è¯ä¹¦ï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œåº”ç”¨ç¨‹åºã€‚è¯ä¹¦é™„å¸¦é™æ€å‘è¡Œç‰ˆæ˜ åƒã€‚è‡³äºæƒé™ï¼Œæˆ‘ä»¬åªéœ€è¦é€‰æ‹©å¸¦æœ‰`nonroot`æ ‡ç­¾çš„å›¾ç‰‡ã€‚

# ğŸ”©å»ºç«‹æ–°çš„ç¤¾åŒº

åŸºæœ¬çš„åˆ†å¸ƒå¼æ˜ åƒ`gcr.io/distroless/base`ï¼ŒåŒ…å«é™æ€æ˜ åƒçš„æ‰€æœ‰å†…å®¹ï¼Œå¤–åŠ :

*   ğŸ‡¨Â·æ ¼åˆ©å¸ƒ
*   ğŸŒlibssl
*   ğŸ”‘openssl

åŸºæœ¬æ˜ åƒæœ€é€‚åˆç”¨äºéœ€è¦ libc/cgo çš„ Go åº”ç”¨ç¨‹åºï¼Œä»¥åŠé™æ€æ˜ åƒæ— æ³•æ”¯æŒçš„æ‰€æœ‰å…¶ä»–é™æ€ç¼–è¯‘çš„åº”ç”¨ç¨‹åºã€‚

# ğŸš®Java Script è¯­è¨€

è€å®è¯´ï¼Œæˆ‘è‡ªå·±å¾ˆå°‘ç”¨åŸºç¡€å›¾åƒã€‚é™æ€å›¾åƒé€šå¸¸æ»¡è¶³æˆ‘å¯¹ç¼–è¯‘åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚ä½†æ˜¯ï¼ŒåŸºç¡€å›¾åƒä»ç„¶éå¸¸é‡è¦ã€‚èŠ‚ç‚¹ distroless æ˜ åƒ`gcr.io/distroless/nodejs:14`åŒ…å«åŸºæœ¬æ˜ åƒåŠ ä¸ŠèŠ‚ç‚¹ç‰ˆæœ¬ 14 åŠå…¶ä¾èµ–é¡¹çš„æ‰€æœ‰å†…å®¹ã€‚

è®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹æˆ‘ä»¬ç”¨æ¥å¾—åˆ°ä¸Šé¢çœ‹åˆ°çš„ç»“æœçš„ä¸€äº› docker æ–‡ä»¶ã€‚

## åºç„¶å¤§ç‰©

åŸºäº buster çš„æ˜ åƒ docker æ–‡ä»¶æ˜¯ä¸€ä¸ªç®€å•çš„å¤šé˜¶æ®µæ„å»ºã€‚æˆ‘ä»¬åªå¤åˆ¶å’Œå®‰è£…ç”Ÿäº§ä¾èµ–é¡¹ã€‚ç„¶åæˆ‘ä»¬å¤åˆ¶ä»£ç ã€‚æˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹è½¬ç§»åˆ°ä¸€ä¸ªæ–°çš„åŸºç¡€æ˜ åƒä¸­ï¼Œç„¶åå¯åŠ¨åº”ç”¨ç¨‹åºã€‚

è¿è¡Œ`snyk container test geo-buster`ç»™å‡ºè¾“å‡º:

```
Tested 414 dependencies for known issues, found 334 issues.
```

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ¼æ´ï¼

## é˜¿å°”å‘æ–¯å±±çš„

é˜¿å°”å‘æ–¯å±±åŸºåœ°å›¾åƒ Dockerfile çš„æ„å»ºä¸ä¸Šé¢çš„å·´æ–¯ç‰¹å›¾åƒç›¸ä¼¼ã€‚

ä½¿ç”¨ Snyk æµ‹è¯•æ˜ åƒçš„æ¼æ´ä¼šäº§ç”Ÿä»¥ä¸‹è¾“å‡º:

```
âœ“ Tested 16 dependencies for known issues, no vulnerable paths found.
```

## Distroless

distro less(geo-distro less-min)docker æ–‡ä»¶æ˜¯äº‹æƒ…å¼€å§‹å˜å¾—æœ‰è¶£çš„åœ°æ–¹ã€‚æˆ‘ä»¬ä½¿ç”¨é˜¿å°”å‘æ–¯å±±ä½œä¸ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåŸºç¡€å›¾åƒã€‚æˆ‘ä»¬æ›´æ–°äº†åŒ…ï¼Œæ·»åŠ äº† curl å¹¶å®‰è£…äº†èŠ‚ç‚¹ä¿®å‰ªã€‚ç„¶åï¼Œæˆ‘ä»¬å¤åˆ¶å¹¶å®‰è£…æ‰€æœ‰çš„ä¾èµ–é¡¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¤åˆ¶ä»£ç ã€‚æˆ‘ä»¬ä½¿ç”¨ npm å’Œ webpack æ¥æ„å»ºæˆ‘ä»¬ä»£ç çš„ç¼©å°å’Œä¸‘åŒ–ç‰ˆæœ¬ï¼Œç„¶åä½¿ç”¨`npm prune --production`ï¼Œåˆ é™¤æ‰€æœ‰çš„å¼€å‘ä¾èµ–ã€‚æ¥ä¸‹æ¥ï¼Œ`node-prune`å¼€å§‹å¸®åŠ©æˆ‘ä»¬è¿›ä¸€æ­¥ç¼©å°å°ºå¯¸ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ„å»ºå’ŒèŠ‚ç‚¹æ¨¡å—å¤åˆ¶åˆ°ä¸€ä¸ªå‘è¡Œç‰ˆæ˜ åƒï¼Œå¹¶è¿è¡Œåº”ç”¨ç¨‹åºã€‚

ä»€ä¹ˆæ˜¯èŠ‚ç‚¹ä¿®å‰ªï¼Ÿ

> èŠ‚ç‚¹ä¿®å‰ªæ˜¯ä¸€ä¸ªå°å·¥å…·ï¼Œä¿®å‰ªä¸å¿…è¦çš„æ–‡ä»¶ã€‚/node_modulesï¼Œå¦‚ markdownã€typescript æºæ–‡ä»¶ç­‰ã€‚

[](/trendyol-tech/how-we-reduce-node-docker-image-size-in-3-steps-ff2762b51d5a) [## æˆ‘ä»¬å¦‚ä½•é€šè¿‡ 3 ä¸ªæ­¥éª¤å‡å°èŠ‚ç‚¹ Docker æ˜ åƒçš„å¤§å°

### ç¼–å†™åº”ç”¨ç¨‹åºå¾ˆç®€å•ã€‚æœ‰è®¸å¤šæ–‡æ¡£ã€æ•™ç¨‹å’Œç¤ºä¾‹å¯ç”¨äºå‡ ä¹æ‰€æœ‰çš„â€¦

medium.com](/trendyol-tech/how-we-reduce-node-docker-image-size-in-3-steps-ff2762b51d5a) 

æµ‹è¯•æ¼æ´æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä»¥ä¸‹è¾“å‡º:

```
Tested 9 dependencies for known issues, found 25 issues.
```

# ğŸ”ï¸ï¼Œä½†æ˜¯é˜¿å°”å‘æ–¯å±±å‘¢ï¼Ÿ

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° distroless ç‰ˆæœ¬æœ‰ 25 ä¸ªæ¼æ´ï¼Œè€Œ Alpine ç‰ˆæœ¬æ²¡æœ‰ã€‚è¿™ä¸å°±æ˜¯è¯´ç”¨é˜¿å°”å‘æ–¯æ›´å¥½å—ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹çœ‹æƒè¡¡ã€‚

å‘è¡Œç‰ˆæ˜ åƒä¸­çš„æ¼æ´æ¥è‡ª:

```
23 - glibc/libc6
 2 - openssl/libssl
 1 - gcc-8/libgcc1
```

è¿™äº›ä¸æ˜¯æ¥è‡ªæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ¼æ´ï¼Œè€Œæ˜¯æ¥è‡ªå‘è¡Œç‰ˆåŸºç¡€æ˜ åƒæœ¬èº«çš„æ¼æ´ã€‚è™½ç„¶è¿™äº›æ¼æ´å¹¶ä¸ç†æƒ³ï¼Œä½†æ˜¯åœ¨ Alpine æ˜ åƒä¸Šä½¿ç”¨ distroless æ˜ åƒè¿˜æ˜¯æœ‰ä¸€äº›å¥½å¤„çš„ã€‚Alpine é™„å¸¦äº†ä¸€ä¸ªåŒ…ç®¡ç†å™¨`apk`å’Œä¸€ä¸ª shell`ash`ã€‚æœ‰äº†å‘è¡Œç‰ˆæ˜ åƒï¼Œä»»ä½•ä¸è‰¯è¡Œä¸ºè€…éƒ½å°†æ— æ³•`docker exec`è¿›å…¥å®¹å™¨å’Œ/æˆ–å®‰è£…æ–°çš„è½¯ä»¶åŒ…ã€‚æœ‰å¾—å¿…æœ‰å¤±ï¼Œç„¶è€Œäºº(è¿™ä¹ŸåŒ…æ‹¬ä½ ï¼)ä¸èƒ½è¿›å…¥å®¹å™¨ç¡®å®æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ã€‚

# ğŸè®¡ç®—æœºç¼–ç¨‹è¯­è¨€

ä¸ Node distroless æ˜ åƒç±»ä¼¼ï¼ŒPython distroless æ˜ åƒ`gcr.io/distroless/python3:nonroot`æ˜¯åœ¨åŸºæœ¬æ˜ åƒçš„åŸºç¡€ä¸Šæ„å»ºçš„ï¼Œä½†æ˜¯ä½¿ç”¨äº† Python 3 åŠå…¶ä¾èµ–é¡¹ã€‚

## åºç„¶å¤§ç‰©

å·´æ–¯ç‰¹æ–‡ä»¶å¾ˆç®€å•ã€‚æˆ‘ä»¬å¤åˆ¶äº†`requirements.txt`ï¼Œå¹¶å’Œå‡çº§ pip ä¸€èµ·å®‰è£…ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¤åˆ¶ä»£ç ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„ buster åŸºç¡€æ˜ åƒï¼Œå¹¶è¿è¡Œåº”ç”¨ç¨‹åºã€‚

å‡äººè€å…„çš„å¼±ç‚¹æœ€å¤šã€‚è¿è¡Œ Snyk æ—¶ï¼Œè¾“å‡ºä¸º:

```
Tested 431 dependencies for known issues, found 349 issues.
```

## é˜¿å°”å‘æ–¯å±±çš„

Alpine Dockerfile æ–‡ä»¶ä¸ Buster Dockerfile æ–‡ä»¶ç›¸ä¼¼ï¼Œåªæ˜¯åŸºç¡€æ˜ åƒä¸åŒã€‚

è¿è¡Œ`snyk container test geo-alpine`è¿”å›:

```
âœ“ Tested 37 dependencies for known issues, no vulnerable paths found.
```

## Distroless

distroless Dockerfile æ–‡ä»¶çš„è¡Œä¸ºä¸ä¸Šé¢ä¸¤ä¸ªç•¥æœ‰ä¸åŒã€‚æˆ‘ä»¬ä½¿ç”¨`apt`æ¥å®‰è£… binutilsï¼Œä½¿ç”¨`pip`æ ¹æ®éœ€æ±‚æ¥å®‰è£… pyinstallerã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¤åˆ¶ä»£ç å¹¶åœ¨`app.py`ä¸Šè¿è¡Œ pyinstallerã€‚æˆ‘ä»¬å°†æ–°åˆ›å»ºçš„`dist`æ–‡ä»¶å¤¹å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„å‘è¡Œç‰ˆæ˜ åƒå¹¶è¿è¡Œåº”ç”¨ç¨‹åºã€‚

Pyinstaller æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„å·¥å…·ã€‚

> PyInstaller å°† Python åº”ç”¨ç¨‹åºå†»ç»“(æ‰“åŒ…)æˆç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶â€¦
> 
> PyInstaller ç›¸å¯¹äºç±»ä¼¼å·¥å…·çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºï¼ŒPyInstaller å¯ä»¥ä¸ Python 3.5â€“3.9 ä¸€èµ·å·¥ä½œï¼Œç”±äºé€æ˜å‹ç¼©ï¼Œå®ƒå¯ä»¥æ„å»ºæ›´å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒå®Œå…¨æ˜¯å¤šå¹³å°çš„ï¼Œå¹¶ä¸”ä½¿ç”¨æ“ä½œç³»ç»Ÿæ”¯æŒæ¥åŠ è½½åŠ¨æ€åº“ï¼Œä»è€Œç¡®ä¿å®Œå…¨å…¼å®¹ã€‚

[](https://www.pyinstaller.org/) [## py installer quick start-py installer æ†ç»‘ Python åº”ç”¨ç¨‹åº

### å¸®åŠ©ä¿æŒ PyInstaller çš„æ´»åŠ›:ç»´æŠ¤ PyInstaller æ˜¯ä¸€é¡¹å·¨å¤§çš„å·¥ä½œã€‚PyInstaller å¼€å‘åªèƒ½â€¦

www.pyinstaller.org](https://www.pyinstaller.org/) 

```
Tested 25 dependencies for known issues, found 38 issues.
```

# ğŸ“¦é›†è£…ç®±åŒ–

distroless æ˜¯çœŸæ­£çš„æœ€ç»ˆæ•‘ä¸–ä¸»å—ï¼Ÿå®ƒå¾ˆå¥½ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚ä¸ Alpine æ˜ åƒç›¸æ¯”ï¼Œdistroless æ˜ åƒæœ‰å‡ ä¸ªæ¼æ´ï¼Œå¹¶ä¸”æ˜ åƒå¤§å°ç¨å¤§ã€‚å½“è°ˆåˆ°æ²¡æœ‰åŒ…ç®¡ç†å™¨æˆ– shell æ—¶ï¼ŒDistroless å äº†ä¸Šé£ã€‚åœ¨é€‰æ‹©æœ€é€‚åˆé¡¹ç›®éœ€æ±‚çš„åŸºç¡€æ˜ åƒä¹‹å‰ï¼Œéœ€è¦ç†è§£å’Œåˆ†ææ¯ä¸ªåº”ç”¨ç¨‹åºåŠå…¶éœ€æ±‚ã€‚

ç°åœ¨ä½ å·²ç»äº†è§£äº†å‘è¡Œç‰ˆï¼Œå®ƒçš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œä½ ç°åœ¨å·²ç»æœ‰äº†ä½ éœ€è¦çš„ä¿¡æ¯æ¥åˆ›å»ºä½ è‡ªå·±çš„å®‰å…¨å’Œæœ€å°çš„ Docker é•œåƒã€‚

# ğŸ“šé¢å¤–èµ„æº

[](https://hackernoon.com/distroless-containers-hype-or-true-value-2rfl3wat) [## åˆ†å¸ƒå¼å®¹å™¨:ç‚’ä½œè¿˜æ˜¯çœŸæ­£çš„ä»·å€¼ï¼Ÿ|é»‘å®¢æ­£åˆ

### è¿™ç¯‡æ–‡ç« æè¿°äº†å®¹å™¨ä¸–ç•Œçš„æœ€æ–°è¶‹åŠ¿ä¹‹ä¸€â€”â€”å®ƒè¢«ç§°ä¸º distroless å®¹å™¨ã€‚å®¹å™¨â€¦

hackernoon.com](https://hackernoon.com/distroless-containers-hype-or-true-value-2rfl3wat) [](https://www.bmc.com/blogs/docker-cmd-vs-entrypoint/) [## Docker CMD ä¸ ENTRYPOINT:æœ‰ä»€ä¹ˆåŒºåˆ«&å¦‚ä½•é€‰æ‹©

### åœ¨äº‘åŸç”Ÿè®¾ç½®ä¸­ï¼ŒDocker å®¹å™¨æ˜¯ç¡®ä¿åº”ç”¨ç¨‹åºè·¨â€¦æœ‰æ•ˆè¿è¡Œçš„åŸºæœ¬å…ƒç´ 

www.bmc.com](https://www.bmc.com/blogs/docker-cmd-vs-entrypoint/) [](https://dwdraju.medium.com/distroless-is-for-security-if-not-for-size-6eac789f695f) [## å¦‚æœä¸æ˜¯ä¸ºäº†å°ºå¯¸ï¼ŒDistroless æ˜¯ä¸ºäº†å®‰å…¨

### å¦‚æœä½ ä¸ç†Ÿæ‚‰å‘è¡Œç‰ˆï¼Œå®ƒçš„å®¹å™¨å›¾åƒæ˜¯ç”± google æ„å»ºçš„ï¼ŒåŸºæœ¬ä¸Šæ˜¯ docker å›¾åƒå‡å»â€¦

dwdraju.medium.com](https://dwdraju.medium.com/distroless-is-for-security-if-not-for-size-6eac789f695f) [](https://betterprogramming.pub/how-to-harden-your-containers-with-distroless-docker-images-c2abd7c71fdb) [## å¦‚ä½•ç”¨ Distroless Docker é•œåƒæ¥åŠ å›ºä½ çš„å®¹å™¨

### åœ¨ Kubernetes ä¸Šä½¿ç”¨ distroless å›¾åƒæ¥ä¿æŠ¤æ‚¨çš„å®¹å™¨

better ç¼–ç¨‹. pub](https://betterprogramming.pub/how-to-harden-your-containers-with-distroless-docker-images-c2abd7c71fdb) [](https://github.com/grycap/minicon) [## grycap/minicon

### å½“ä½ è¿è¡Œå®¹å™¨æ—¶(ä¾‹å¦‚åœ¨ Docker ä¸­)ï¼Œä½ é€šå¸¸è¿è¡Œä¸€ä¸ªæ‹¥æœ‰å®Œæ•´æ“ä½œç³»ç»Ÿã€æ–‡æ¡£â€¦

github.com](https://github.com/grycap/minicon) [](https://docs.docker.com/develop/develop-images/multistage-build/) [## ä½¿ç”¨å¤šé˜¶æ®µæ„å»º

### å¤šé˜¶æ®µæ„å»ºå¯¹äºé‚£äº›åŠªåŠ›ä¼˜åŒ– docker æ–‡ä»¶åŒæ—¶ä¿æŒå®ƒä»¬æ˜“äºé˜…è¯»å’Œä½¿ç”¨çš„äººæ¥è¯´æ˜¯éå¸¸æœ‰ç”¨çš„

docs.docker.com](https://docs.docker.com/develop/develop-images/multistage-build/)