<html>
<head>
<title>Change Retrofit Base URL on Runtime.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">è¿è¡Œæ—¶æ›´æ”¹ç¿»æ–°åŸºç¡€URLã€‚</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/nerd-for-tech/change-retrofit-base-url-on-runtime-2036ef1dee44?source=collection_archive---------0-----------------------#2021-09-05">https://medium.com/nerd-for-tech/change-retrofit-base-url-on-runtime-2036ef1dee44?source=collection_archive---------0-----------------------#2021-09-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="629f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ä¹‹é—´åˆ‡æ¢å¤šä¸ªåŸºæœ¬ç½‘å€å–œæ¬¢äº§å“|å¼€å‘æ”¹é€ å®¹æ˜“ã€‚</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/3f9b997489d744178294dc856ca89bce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8IOK-CnOvbbyuYyCcwOPvA.png"/></div></div></figure><p id="03d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ğŸ—¡Hiï¼Œå¾ˆé«˜å…´åœ¨è¿™é‡Œè§åˆ°ä½ ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€çŸ­çš„æŠ€æœ¯æ¥æ”¹å˜æ”¹é€ åŸºç¡€ç½‘å€ã€‚</p><h1 id="2c6a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">ç®€ä»‹</strong></h1><p id="0cae" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><strong class="ih hj">æ”¹å‹</strong>æ˜¯Squareå¼€å‘çš„ä¸€æ¬¾ç”¨äºAndroidã€Javaå’ŒKotlinçš„ç±»å‹å®‰å…¨HTTPå®¢æˆ·ç«¯ã€‚è¯¥åº“æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œç”¨äºéªŒè¯APIå¹¶ä¸ä¹‹äº¤äº’ï¼Œä»¥åŠä½¿ç”¨<a class="ae ks" href="http://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> OkHttp </a>å‘é€ç½‘ç»œè¯·æ±‚ã€‚</p><p id="12bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æˆ‘ä»¬é€šè¿‡æä¾›é»˜è®¤çš„åŸºæœ¬urlæ¥å®ä¾‹åŒ–æ”¹é€ å®ä¾‹ã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="87ba" class="ky jq hi ku b be kz la l lb lc">return new Retrofit.Builder()<br/>            .client(okHttpClient)<br/>            .baseUrl(BuildConfig.PRODUCTION_BASE_URL)<br/>            .addConverterFactory(-)<br/>            .addCallAdapterFactory(-)<br/>            .build();</span></pre><p id="fde3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">é—®é¢˜æŠ¥å‘Š</strong></p><p id="ad9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">è¿è¡Œæ—¶åœ¨ä¸åŒçš„urlä¹‹é—´åˆ‡æ¢å¾ˆå›°éš¾ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªå›°éš¾ï¼Œå¼€å‘è€…è¢«è¿«åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ä¸¤ä¸ªæ”¹å‹å®ä¾‹ã€‚ä¸ºäº†é¿å…åœ¨åº”ç”¨ç¨‹åºä¸­å‡ºç°è¿™ä¸¤ç§æˆ–ä¸¤ç§ä»¥ä¸Šçš„æ”¹å‹ï¼Œæˆ‘ä»¬å¼€å‘äººå‘˜ä½¿ç”¨äº†ä¸åŒçš„æŠ€æœ¯ï¼Œä¾‹å¦‚</p><ol class=""><li id="5cfc" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">æ›´æ–°åŠ¨æ€URLâ€”â€”å†—é•¿ä¹å‘³</li><li id="d057" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">å€ŸåŠ©å…±äº«é¦–é€‰é¡¹âœ…æ›´æ”¹ä¸»æœºURLçš„æ‹¦æˆªå™¨</li><li id="435a" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">å°†BASE_URLç›´æ¥å­˜å‚¨åœ¨å…±äº«Prefä¸­â€”</li><li id="d104" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">reinit ok http/ç¿»æ–°â€”</li></ol><p id="f13e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æ›´å¤š..</p><p id="8601" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lr">è¿™é‡Œï¼Œæˆ‘ä»¬å°†å®æ–½æ–¹æ³•2ã€‚</em></p><p id="f92a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">è®©æˆ‘ä»¬é€šè¿‡è®¾ç½®ä¾èµ–é¡¹æ¥æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="fc7e" class="ky jq hi ku b be kz la l lb lc">ext {<br/>      okHttpVersion = "4.8.1"<br/>      retrofitVersion = "2.9.0"<br/>      hiltVersion = "2.38.1"<br/>}<br/>// Implementation<br/>// OkHttp<br/>implementation "com.squareup.okhttp3:okhttp:$rootProject.okHttpVersion"<br/>implementation "com.squareup.okhttp3:logging-interceptor:$rootProject.okHttpVersion"<br/><br/>// Retrofit2<br/>implementation "com.squareup.retrofit2:retrofit:$rootProject.retrofitVersion"<br/>implementation "com.squareup.retrofit2:converter-gson:$rootProject.retrofitVersion"<br/>implementation "com.github.akarnokd:rxjava3-retrofit-adapter:3.0.0"<br/>implementation "com.squareup.retrofit2:converter-protobuf:$rootProject.retrofitVersion"<br/><br/>// Hilt<br/>implementation "com.google.dagger:hilt-android:$rootProject.hiltVersion"<br/>annotationProcessor "com.google.dagger:hilt-android-compiler:$rootProject.hiltVersion"<br/>annotationProcessor 'androidx.hilt:hilt-compiler:1.0.0'</span></pre><blockquote class="ls lt lu"><p id="eb65" class="if ig lr ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">App.java</p><p id="5abf" class="if ig lr ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">å¸¦åŒ•é¦–2åˆ€æŸ„ã€‚</p></blockquote><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="af6c" class="ky jq hi ku b be kz la l lb lc">@HiltAndroidApp<br/>public class App extends Application {<br/><br/>    @Override<br/>    public void onCreate() {<br/>        super.onCreate();<br/>        Hawk.init(this).build();<br/>        AppLog.init();<br/>    }<br/><br/>    @Override<br/>    protected void attachBaseContext(Context base) {<br/>        super.attachBaseContext(base);<br/>        MultiDex.install(this);<br/>    }<br/>}</span></pre><p id="0fdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ç°åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ªåŠ©æ‰‹å‡½æ•°çš„preference helper(SharedPrefManager)æ¥è¯»/å†™å½“å‰ç¯å¢ƒé€‰æ‹©æ¨¡å¼çš„çŠ¶æ€ã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="1763" class="ky jq hi ku b be kz la l lb lc"> // Store &amp; Get Prod or Dev Environment<br/><br/> void setProdEnvironmentStatus(boolean status);<br/> boolean isProdEnvironment();</span></pre><p id="00d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ç„¶åï¼Œåˆ›å»º<strong class="ih hj">æ‹¦æˆªå™¨</strong>æ¥å¤„ç†åˆ‡æ¢ç¯å¢ƒå·¥ä½œã€‚ğŸ˜®</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="b223" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å¯¹äºé»˜è®¤çš„åŸºæœ¬urlï¼Œå°†ä½¿ç”¨DEVELOPMENT_BASE_URLæ³¨å…¥æ›´æ–°ï¼Œå‡å®šä¸ºåº”ç”¨ç¨‹åºçš„é»˜è®¤é€‰æ‹©ã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="5e66" class="ky jq hi ku b be kz la l lb lc">@Provides<br/>@Singleton<br/>public Retrofit provideRetrofitClient(ProtoConverterFactory protoConverterFactory, RxJava3CallAdapterFactory rxJava3CallAdapterFactory, OkHttpClient okHttpClient) {return new Retrofit.Builder()<br/>            .client(okHttpClient)<br/>            .baseUrl(BuildConfig.DEVELOPMENT_BASE_URL)<br/>            .addConverterFactory(protoConverterFactory)<br/>            .addCallAdapterFactory(rxJava3CallAdapterFactory)<br/>            .build();<br/>}</span></pre><p id="4496" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">ç°åœ¨</strong>æä¾›<strong class="ih hj">HostSelectionInterceptor</strong>ä¾èµ–ç»™NetworkModule.javaçš„hant asï¼Œ</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="7508" class="ky jq hi ku b be kz la l lb lc">@Provides<br/>@Singleton<br/>public HostSelectionInterceptor provideHostSelectionInterceptor(PreferenceHelper preferenceHelper) {<br/>    return new HostSelectionInterceptor(preferenceHelper);<br/>}</span></pre><p id="263b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ç„¶åï¼Œå°†è¿™ä¸ªæ‹¦æˆªå™¨æä¾›ç»™æˆ‘ä»¬çš„OkHttpClientæ„å»ºå™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="02d8" class="ky jq hi ku b be kz la l lb lc">@Provides<br/>@Singleton<br/>public OkHttpClient provideOkHttpClient(@ApplicationContext Context context, HttpLoggingInterceptor httpLoggingInterceptor, HostSelectionInterceptor hostSelectionInterceptor) {<br/><br/>    long cacheSize = 5 * 1024 * 1024;<br/>    Cache mCache = new Cache(context.getCacheDir(), cacheSize);<br/>    if (BuildConfig.DEBUG) {<br/>        return new OkHttpClient().newBuilder()<br/>                .cache(mCache)<br/>                .retryOnConnectionFailure(true)<br/>                .connectTimeout(200, TimeUnit.SECONDS)<br/>                .readTimeout(200, TimeUnit.SECONDS)<br/>                .addInterceptor(httpLoggingInterceptor)<br/>                .addInterceptor(hostSelectionInterceptor)<br/>                .followRedirects(true)<br/>                .followSslRedirects(true)<br/>                .build();<br/><br/>    } else {<br/>        return new OkHttpClient().newBuilder()<br/>                .connectTimeout(200, TimeUnit.SECONDS)<br/>                .readTimeout(200, TimeUnit.SECONDS)<br/>                .retryOnConnectionFailure(true)<br/>                .followRedirects(true)<br/>                .followSslRedirects(true)<br/>                .addInterceptor(hostSelectionInterceptor)<br/>                .build();<br/>    }<br/><br/>}</span></pre><p id="d7fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€æä¾›@ <strong class="ih hj"> Inject </strong>æ³¨é‡Šï¼Œå°±å¯ä»¥<strong class="ih hj">å°†</strong><strong class="ih hj">HostSelectionInterceptor</strong>æ³¨å…¥åˆ°æˆ‘ä»¬çš„è§†å›¾æ¨¡å‹æˆ–æ´»åŠ¨ä¸­ã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="055a" class="ky jq hi ku b be kz la l lb lc">@Inject<br/>    HostSelectionInterceptor hostSelectionInterceptor;</span></pre><p id="d95d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">æœ€å</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›ç¯å¢ƒä¹‹é—´åˆ‡æ¢ï¼Œåªéœ€æ›´æ”¹å…±äº«åå¥½è®¾ç½®ä¸Šçš„é€‰æ‹©æ¨¡å¼çŠ¶æ€ï¼Œå¹¶è°ƒç”¨<strong class="ih hj">HostSelectionInterceptor</strong>ä¸­çš„<strong class="ih hj"> setHostBaseUrl </strong>å‡½æ•°ã€‚</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ma"><img src="../Images/44e22776b2f3b4717529da6f0106c60b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*xQnn65qsfYsvVNUm.gif"/></div></figure><p id="a35d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">â€œå¼€å‘â€å’Œâ€œç”Ÿäº§â€ç¯å¢ƒçš„å¾®è°ƒå¼€å…³ç¤ºä¾‹ã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="ac1c" class="ky jq hi ku b be kz la l lb lc">private void doSetupHostSelection() {<br/><br/>    ArrayAdapter&lt;String&gt; arrayAdapter = new CustomSpinnerAdapter(this).spinnerAdapter();<br/>    //Setting the ArrayAdapter data on the Spinner<br/>    arrayAdapter.add("DEV");<br/>    arrayAdapter.add("PROD");<br/>    getViewDataBinding().spinnerHostSelection.setAdapter(arrayAdapter);<br/><br/><br/>// selector    <br/>getViewDataBinding().spinnerHostSelection.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {<br/>        @Override<br/>        public void onItemSelected(AdapterView&lt;?&gt; parent, View view, int position, long id) {<br/><br/>            if (position == 0) {<br/>                preferenceHelper.setProdEnvironmentStatus(false);<br/>                hostSelectionInterceptor.setHostBaseUrl();<br/><br/>            } else {<br/>                preferenceHelper.setProdEnvironmentStatus(true);<br/>                hostSelectionInterceptor.setHostBaseUrl();<br/>            }<br/>        }<br/><br/>        @Override<br/>        public void onNothingSelected(AdapterView&lt;?&gt; parent) {<br/><br/>        }<br/>    });<br/><br/>}</span></pre><p id="876b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">è¿™ä¸ªå‡½æ•°<strong class="ih hj"> setHostBaseUrl </strong>å°†å®Œæˆå‰©ä¸‹çš„å·¥ä½œã€‚</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="0c8a" class="ky jq hi ku b be kz la l lb lc">public void setHostBaseUrl() {<br/>    if (preferenceHelper.isProdEnvironment()) {<br/>        this.host = HttpUrl.parse(BuildConfig.PRODUCTION_BASE_URL);<br/>    } else {<br/>        this.host = HttpUrl.parse(BuildConfig.DEVELOPMENT_BASE_URL);<br/>    }<br/>}</span></pre><p id="b85e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å°±è¿™äº›â€¦æ„Ÿè°¢æ‚¨çš„é˜…è¯»â€¦</p><blockquote class="mb"><p id="2330" class="mc md hi bd me mf mg mh mi mj mk jc dx translated">Ps:ä¸Šé¢çš„å®ç°åªæ˜¯ä¸€ä¸ªæ ·æœ¬ï¼Œæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ä¸åŒçš„ç½‘å€è¿›è¡Œæ”¹é€ ã€‚è¿™ç§æŠ€æœ¯çš„å®ç°å–å†³äºæ‚¨çš„éœ€æ±‚ã€‚</p></blockquote><p id="18a6" class="pw-post-body-paragraph if ig hi ih b ii ml ik il im mm io ip iq mn is it iu mo iw ix iy mp ja jb jc hb bi translated">æŠ“ä½è¿™ä¸ªæƒ³æ³•å¹¶ä»¥ä½ æœ€å¥½çš„æ–¹å¼å®ç°å®ƒï¼</p><p id="3d41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å¦‚æœ‰ä»»ä½•å›°æƒ‘æˆ–å»ºè®®ï¼Œè¯·å¡«å†™è¯„è®ºéƒ¨åˆ†ğŸ§</p></div></div>    
</body>
</html>